<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Level {{ level }} • Bingo Quiz</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" sizes="32x32">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}" sizes="180x180">

<style>
/* ===========================================================
   CHILD-LIKE THEME (bright, bubbly, sticker-y, friendly)
   =========================================================== */
:root{
  --ink:#13254b; --muted:#5c6ea3; --bg:#fcfdff; --card:#ffffff; --line:#e6eeff; --ring:#dbe6ff;
  --c-blue:#6d8bff; --c-sky:#a9c5ff; --c-mint:#62e2c1; --c-sun:#ffd76b; --c-rose:#ff9fbb; --c-grape:#b99bff;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  --shadow-1:0 12px 28px rgba(19,37,75,.10);
  --shadow-2:0 22px 52px rgba(19,37,75,.16);
}
body.lvl-1{ --c-blue:#8ab4ff; --c-sky:#cfe0ff; --c-mint:#a5f3dc; --c-sun:#ffe58a; --c-rose:#ffc2d4; --c-grape:#d6c4ff; }
body.lvl-2{ --c-blue:#6d8bff; --c-sky:#a9c5ff; --c-mint:#62e2c1; --c-sun:#ffd76b; --c-rose:#ff9fbb; --c-grape:#b99bff; }
body.lvl-3{ --c-blue:#5570ff; --c-sky:#99b8ff; --c-mint:#39d7b2; --c-sun:#ffcf4d; --c-rose:#ff86ad; --c-grape:#a787ff; }
body.lvl-4{ --c-blue:#4058ff; --c-sky:#88acff; --c-mint:#22c7a7; --c-sun:#ffc22e; --c-rose:#ff6a9b; --c-grape:#936dff; }
body.lvl-5{ --c-blue:#2f46ff; --c-sky:#7ba3ff; --c-mint:#10bfa0; --c-sun:#ffb814; --c-rose:#ff5a8f; --c-grape:#845bff; }

/* Global */
html,body{height:100%}
body{
  font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  color:var(--ink);
  background:
    radial-gradient(42vmax 42vmax at 12% 6%, #eef3ff 0%, transparent 70%),
    radial-gradient(36vmax 36vmax at 85% -8%, #f7f8ff 0%, transparent 72%),
    var(--bg);
  background-attachment: fixed;
}
.container{max-width:1120px}

.pill{background:#fff;border:1px solid var(--line);color:#223764;font-weight:900;border-radius:999px;padding:.42rem .82rem;display:inline-flex;align-items:center;gap:.5rem;box-shadow:var(--shadow-1)}
.pill i{opacity:.9}

.card-glass{
  border:1px solid var(--line);
  background:linear-gradient(180deg,#ffffff 0%, #f7f9ff 100%);
  border-radius:24px;
  box-shadow:var(--shadow-2);
}

.progress{height:14px;background:#eef3ff;border:1px solid #e2ebff;border-radius:999px;overflow:hidden}
.progress-bar{background:linear-gradient(90deg,var(--c-blue),var(--c-sky));font-weight:900}

/* Toasts */
.toastline{position:fixed;right:1rem;bottom:1rem;background:#eafff3;border:1px solid #baf3d0;padding:.65rem .9rem;border-radius:14px;box-shadow:0 10px 26px rgba(19,37,75,.12);z-index:9999;display:none;color:#0b3b22;font-weight:800}
.resume-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:1rem;background:#eef7ff;color:#0e1b35;border:1px solid #cfe2ff;border-radius:14px;padding:.6rem .9rem;box-shadow:0 10px 26px rgba(19,37,75,.12);display:none;z-index:9999;font-weight:800}
.leave-toast{position:fixed;left:50%;transform:translateX(-50%) translateY(20px);bottom:1rem;background:#fff7ed;color:#7c2d12;border:1px solid #fed7aa;border-radius:14px;padding:.7rem 1rem;z-index:10000;box-shadow:0 10px 26px rgba(124,45,18,.18);display:none;font-weight:900}
@keyframes slideUpFade{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes fadeOut{to{opacity:0}}

/* Modal wiggle when clicking backdrop */
@keyframes modalWiggle {
  0% { transform: translateY(0) scale(1); }
  18%{ transform: translateY(-2px) scale(1.01); }
  36%{ transform: translateY(0) scale(1); }
  54%{ transform: translateY(-1px) scale(1.005); }
  100%{ transform: translateY(0) scale(1); }
}
.modal-wiggle{ animation: modalWiggle .35s cubic-bezier(.2,.8,.2,1); }

/* ===================== BINGO BOARD ===================== */
.board-wrap{
  position:relative;border:1px solid var(--line);border-radius:26px;padding:18px;
  background:
    radial-gradient(320px 220px at -10% -10%, #eef4ff 0%, transparent 60%),
    radial-gradient(320px 220px at 110% 110%, #fef6ff 0%, transparent 60%),
    linear-gradient(180deg,#ffffff 0%, #f8fbff 100%);
  box-shadow:var(--shadow-2);overflow:hidden;
}
.board{ display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }

.cell{
  position:relative;min-height:120px;border-radius:20px;cursor:pointer;overflow:hidden;border:1px solid var(--line);
  background:
    radial-gradient(140px 90px at 105% -10%, #f1f5ff 0%, transparent 65%),
    linear-gradient(180deg,#ffffff 0%, #f7f9ff 100%);
  box-shadow:0 6px 0 #e8eeff, 0 10px 26px rgba(19,37,75,.10);
  transition:transform .14s ease, box-shadow .14s ease, border-color .14s ease, outline .14s ease;
  perspective:900px; isolation:isolate;
}
.cell:hover{ transform:translateY(-3px) rotateZ(-.2deg); box-shadow:0 10px 0 #e4ebff, 0 20px 44px rgba(19,37,75,.16); border-color:#d7e3ff }
.cell.correct{ outline:3px solid #a7f3d0; }
.cell.wrong{   outline:3px solid #fecaca; }
.cell.locked{ pointer-events:none; opacity:.92 }

.cell::after{ content:""; position:absolute; inset:auto 0 0 0; height:10px;
  background:linear-gradient(90deg,var(--c-blue),var(--c-sky)); opacity:.9; }
.cell.type-short::after{ background:linear-gradient(90deg,var(--c-sun),#ffe19e) }
.cell.type-long::after{  background:linear-gradient(90deg,var(--c-rose),#ffc7da) }

.cell .inner{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .45s cubic-bezier(.2,.7,.2,1)}
.cell.flipped .inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:1rem;backface-visibility:hidden}
.face.front{text-align:center}
.type-emblem{display:inline-flex;align-items:center;gap:.6rem;border-radius:16px;padding:.6rem .9rem;font-weight:900;letter-spacing:.3px;color:#13254b;border:1px solid var(--line);background:#fff;box-shadow:var(--shadow-1)}
.em-mcq{  background:linear-gradient(180deg,#ffffff,#f0f5ff); border-color:#e4ebff }
.em-short{background:linear-gradient(180deg,#fff8e6,#fff2cf); border-color:#ffe7a3 }
.em-long{ background:linear-gradient(180deg,#fff0f6,#ffe3ee); border-color:#ffd0e2 }
.front-cta{margin-top:.5rem;color:var(--muted);font-weight:800}
.face.back{transform:rotateY(180deg);color:#2b3d6b;font-weight:900;font-size:1.06rem}
.cell .badge-done{position:absolute; bottom:.55rem; right:.55rem;background:#fff; border:1px solid var(--line); border-radius:999px;padding:.28rem .65rem; font-weight:900; font-size:.82rem; color:#223764; box-shadow:var(--shadow-1)}

/* ===================== MODALS ===================== */
.modal-content{
  background:linear-gradient(180deg,#ffffff,#f7f9ff);
  border:1px solid var(--line); color:var(--ink);
  border-radius:22px; box-shadow:0 24px 60px rgba(19,37,75,.18);
}
.modal-header{border-bottom:1px solid var(--line)}
.modal-footer{border-top:1px solid var(--line)}
.badge-type{border-radius:999px;padding:.35rem .7rem;font-weight:900;letter-spacing:.3px;border:1px solid var(--line);background:#fff}

.btn-ghost{border:2px solid var(--ring); color:#17305a; background:linear-gradient(180deg,#fff,#f9fbff); border-radius:14px; font-weight:900}
.btn-ghost:hover{filter:brightness(1.03)}
.btn-gradient{border:none; color:#0b1632; font-weight:900; border-radius:14px;background:linear-gradient(90deg,var(--c-blue),var(--c-sky));box-shadow:0 14px 28px rgba(109,139,255,.28)}
.btn-gradient:hover{filter:brightness(1.04)}

.option-btn{border:1.5px solid var(--line)!important;background:linear-gradient(180deg,#fff,#f7f9ff)!important;color:#0e1b35!important;padding:14px 16px!important;border-radius:14px!important;transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease}
.option-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(19,37,75,.12)}
.option-btn.sel{box-shadow:0 0 0 .25rem #dbe6ff; border-color:#cfe2ff!important}
.option-btn.correct{border-color:#34d399!important;background:linear-gradient(145deg, rgba(34,197,94,.10), transparent)!important}
.option-btn.wrong{border-color:#f08c8c!important;background:linear-gradient(145deg, rgba(248,113,113,.10), transparent)!important}

.quiz-input{background:#fff;color:#0e1b35;border:1.5px solid var(--line);padding:14px 16px;border-radius:14px}
.quiz-input:focus{border-color:#cfe2ff;box-shadow:0 0 0 .25rem var(--ring)}

/* Required-words chips for long answer */
.req-wrap{display:flex;flex-wrap:wrap;gap:.4rem .5rem;margin:.6rem 0 0}
.req-chip{
  display:inline-flex;align-items:center;gap:.4rem;
  border:1px solid var(--line); background:#fff; color:#1b2d52;
  padding:.35rem .6rem; border-radius:999px; font-weight:900; box-shadow:var(--shadow-1);
}
.req-chip .dot{width:8px;height:8px;border-radius:999px;background:#e5e7eb}
.req-chip.hit{border-color:#a7f3d0;background:linear-gradient(180deg,#ecfdf5,#ffffff)}
.req-chip.hit .dot{background:#34d399}
.req-chip.miss{border-color:#fecaca;background:linear-gradient(180deg,#fff1f2,#ffffff)}
.req-chip.miss .dot{background:#ef4444}

/* Over / LevelUp headers */
.over-head{background:linear-gradient(135deg,#fee2e2,#fff1f1);border-bottom:1px solid #ffd9d9;padding-block:18px!important}
.over-title{display:flex;align-items:center;gap:.6rem;margin:0;font-weight:900;color:#7f1d1d}
.over-title .glyph{display:inline-grid;place-items:center;width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg,#ffd2d2,#ffe8e8);border:1px solid #ffc9c9;color:#991b1b;box-shadow:inset 0 1px 0 #fff,0 10px 20px rgba(127,29,29,.10)}
.over-body{background:linear-gradient(180deg,#fff,#f7faff);color:#374151}
.stat-row{display:flex;flex-wrap:wrap;gap:.5rem .6rem;margin:.4rem 0 0}
.stat-chip{display:inline-flex;align-items:baseline;gap:.35rem;border:1px solid var(--line);background:#fff;color:#223357;padding:.35rem .6rem;border-radius:12px;font-weight:900;box-shadow:var(--shadow-1)}
.stat-chip small{font-weight:800;color:#60719a}
.over-footer{border-top:1px solid var(--line);background:linear-gradient(180deg,#fff,#f7faff)}

.level-head{background:linear-gradient(135deg,#dcfce7,#e9ffe9);border-bottom:1px solid #bbf7d0;padding-block:18px!important}
.level-title{display:flex;align-items:center;gap:.6rem;margin:0;font-weight:900;letter-spacing:.2px;color:#065f46}
.level-title .burst{width:44px;height:44px;border-radius:14px;display:inline-grid;place-items:center;font-size:22px;background:linear-gradient(135deg,#bbf7d0,#86efac);border:1px solid #a7f3d0;color:#065f46;box-shadow:inset 0 1px 0 #fff,0 10px 24px rgba(6,95,70,.14);animation:pop 450ms cubic-bezier(.2,.8,.2,1)}
.level-body{background:linear-gradient(180deg,#fff,#f7faff);color:#0f172a}
.level-ribbon{display:inline-flex;align-items:center;gap:.5rem;font-weight:900;padding:.5rem .8rem;border-radius:999px;background:linear-gradient(90deg,#34d399,#22c55e);color:#052e1a;box-shadow:0 10px 24px rgba(5,46,26,.15)}
.level-number{font-size:2.2rem;font-weight:900;background:linear-gradient(90deg,#34d399,#a7f3d0);-webkit-background-clip:text;background-clip:text;color:transparent}

/* Confetti */
.confetti{position:fixed;top:-10px;left:0;width:8px;height:12px;border-radius:2px;z-index:9999}

/* Accessibility */
.visually-hidden-focusable:active,
.visually-hidden-focusable:focus{position:static!important;width:auto!important;height:auto!important;margin:0!important;overflow:visible!important;clip:auto!important}
</style>
</head>

<body class="lvl-{{ lvl }}">
{% include 'nav.html' %}

<div class="container pb-5 mt-4">
  <!-- Header / HUD -->
  <div class="card-glass p-3 mb-3">
    <div class="d-flex align-items-center gap-3 flex-wrap">
      <div class="me-auto d-flex align-items-center gap-2">
        <span class="pill" id="lifeChip"><i class="bi bi-heart-fill"></i> Lives 3</span>
        <span class="pill" id="xpChip"><i class="bi bi-stars"></i> Board XP 0</span>
        <span class="pill" id="lineChip"><i class="bi bi-grid-3x3"></i> Lines 0</span>
        <span class="pill" id="profileChip">
          <i class="bi bi-person-fill"></i>
          Lv <span id="profileLevel">{{ user_level|default(1) }}</span>
          • <span id="profileXPNow">{{ (user_xp|default(0)) % 100 }}</span>/100
          • Total <span id="profileXPTotal">{{ user_xp|default(0) }}</span>
        </span>
      </div>
      <div class="flex-grow-1" style="min-width:220px; max-width:420px;">
        <div class="small mb-1" style="color:#223357;">Progress <span id="progLabel"></span></div>
        <div class="progress">
          <div class="progress-bar" id="barFill" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bingo Board -->
  <div class="board-wrap mb-3">
    <div class="board" id="board"></div>
  </div>

  <!-- Finish Card -->
  <div class="card-glass text-center mt-3" id="finishCard" style="display:none">
    <div class="card-body p-5">
      <h2 class="h3 fw-bold mb-2" id="finishTitle"
          style="font-family:Fredoka,Nunito,sans-serif; background:linear-gradient(90deg,var(--c-mint),#d1fae5);-webkit-background-clip:text;background-clip:text;color:transparent;">
        Board complete!
      </h2>
      <p id="finishStats" class="mb-4" style="color:var(--muted)"></p>
      <div class="d-flex justify-content-center gap-2">
        <a class="btn btn-ghost px-4" href="{{ url_for('home') }}">Back to Home</a>
        <form method="POST" action="{{ url_for('submit_quiz_instance', quiz_id=quiz_id) }}">
          <button class="btn btn-gradient px-4" type="submit">
            <i class="bi bi-save2 me-1"></i> Save Result
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toastline" id="toastLine"><i class="bi bi-trophy me-1"></i> Line completed! +20 XP</div>
<div class="resume-toast" id="resumeToast"><i class="bi bi-clock-history me-1"></i> Resumed your saved board.</div>
<div class="leave-toast mb-4" id="leaveToast" role="status" aria-live="assertive"><i class="bi bi-exclamation-triangle-fill"></i> Solve this question first!</div>

<!-- Question Modal -->
<div class="modal fade" id="qModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content" id="qModalContent">
      <div class="modal-header align-items-center">
        <h5 class="modal-title" style="font-family:Fredoka,Nunito,sans-serif;font-weight:800"><span id="modalCellTitle">Cell</span></h5>
        <span class="ms-3 badge-type" id="modalTypeBadge">Multiple Choice</span>
        <button type="button" class="btn-close ms-auto" id="modalHeaderClose" aria-label="Close" style="display:none"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3" id="modalPrompt" style="color:var(--muted)"></p>

        <!-- MCQ / Short / Long blocks -->
        <div id="modalMCQ" class="vstack gap-2 mb-3" style="display:none"></div>

        <div id="modalShort" style="display:none">
          <input class="quiz-input w-100" id="modalShortInput" placeholder="Type your answer here…" />
        </div>

        <!-- LONG: open-ended + required-words chips -->
        <div id="modalLong" style="display:none">
          <textarea class="quiz-input w-100" rows="3" id="modalLongInput" placeholder="Write one clear sentence…"></textarea>
          <div class="form-text" id="modalLongHelper">Include all required words (case-insensitive).</div>
          <div class="req-wrap" id="requiredWords" aria-live="polite"></div>
        </div>

        <div id="modalFeedback" class="mt-3"></div>
        <div id="modalExplain" class="mt-2" style="display:none"></div>
        <div id="modalLockHint" class="mt-2" style="display:none">
          <i class="bi bi-lock-fill me-1"></i> This cell is locked (already checked).
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="modalClearBtn" type="button">
          <i class="bi bi-eraser"></i> Clear
        </button>
        <button class="btn btn-gradient" id="modalCheckBtn" type="button">Check</button>
        <button class="btn btn-ghost" id="modalCloseBtn" type="button" data-bs-dismiss="modal" style="display:none">
          <i class="bi bi-x-circle me-2"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div class="modal fade" id="overModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header over-head">
        <h5 class="over-title">
          <span class="glyph"><i class="bi bi-emoji-frown"></i></span>
          Out of lives
        </h5>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body over-body">
        <p class="mb-2">You ran out of lives on this board. Here’s how you did:</p>
        <div class="stat-row">
          <span class="stat-chip"><small>Solved</small> <b id="overSolved">0/16</b></span>
          <span class="stat-chip"><small>Lines</small> <b id="overLines">0</b></span>
          <span class="stat-chip"><small>XP</small> <b id="overXP">0</b></span>
        </div>
        <p id="overStats" class="visually-hidden"></p>
        <div class="mt-3 small text-secondary">
          Tip: try diagonals early or pick 2–3 easy cells per row for faster lines.
        </div>
      </div>
      <div class="modal-footer over-footer">
        <a class="btn btn-ghost" href="{{ url_for('home') }}"><i class="bi bi-house-door me-1"></i> Home</a>
        <button class="btn btn-gradient" id="overRetryBtn" type="button"><i class="bi bi-arrow-repeat me-1"></i> Try again</button>
      </div>
    </div>
  </div>
</div>

<!-- Level Up Modal -->
<div class="modal fade" id="levelUpModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header level-head">
        <h5 class="level-title">
          <span class="burst"><i class="bi bi-award"></i></span>
          Level Up!
        </h5>
        <button type="button" class="btn-close ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body level-body text-center">
        <div class="mb-1"><span class="level-ribbon"><i class="bi bi-lightning-charge-fill me-1"></i> Congrats!</span></div>
        <div class="level-number mt-2" id="levelUpNumber">Lv 2</div>
        <div class="small text-muted mt-1">Total XP: <b id="levelUpXP">120</b></div>
      </div>
      <div class="modal-footer" style="border-top:1px solid var(--line); background:linear-gradient(180deg,#fff,#f7f9ff);">
        <button class="btn btn-gradient w-100" data-bs-dismiss="modal"><i class="bi bi-emoji-laughing me-1"></i> Awesome</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= Template data ========= */
const RAW = {{ qs|tojson }};
const QUIZ_ID = {{ quiz_id }};
const BOARD_SIZE = 4, TOTAL = 16;
const LVL = Number({{ lvl|default(1) }});  // current board level

/* ========= Fixed position map ========= */
const POSMAP = {};
for (const q of RAW){
  const p = (q.extra_parsed && typeof q.extra_parsed.pos === 'number') ? q.extra_parsed.pos : null;
  if (p!==null && p>=0 && p<16) POSMAP[p] = q;
}
const QUESTIONS = Array.from({length:16}, (_,i)=> POSMAP[i] ?? RAW.find(r => !Object.values(POSMAP).includes(r)));

/* ========= Profile ========= */
let PROFILE_LEVEL = Number({{ user_level|default(1) }});
let PROFILE_XP    = Number({{ user_xp|default(0) }});
const elProfileLevel   = document.getElementById('profileLevel');
const elProfileXPNow   = document.getElementById('profileXPNow');
const elProfileXPTotal = document.getElementById('profileXPTotal');

let LAST_LEVEL = PROFILE_LEVEL;
let LAST_XP    = PROFILE_XP;

/* ========= Board State ========= */
let lives = 3, xp = 0, lines = 0;
let selectedPos = null;
let answered = new Set();
let correct = new Set();
let awardedLines = new Set();
let finished = false;

/* ========= Local persistence ========= */
const LS_KEY = (id)=> `bingo_state_${id}`;
function exportState(){
  return { lives, xp, lines, answered:[...answered], correct:[...correct], awardedLines:[...awardedLines], ts: Date.now() };
}
function saveState(){ try{ localStorage.setItem(LS_KEY(QUIZ_ID), JSON.stringify(exportState())); }catch(e){} }
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY(QUIZ_ID)); if(!raw) return false;
    const s = JSON.parse(raw)||{}; if (typeof s!=='object') return false;
    if (Number.isFinite(s.lives)) lives = s.lives;
    if (Number.isFinite(s.xp))    xp    = s.xp;
    if (Number.isFinite(s.lines)) lines = s.lines;
    answered = new Set(Array.isArray(s.answered)? s.answered : []);
    correct  = new Set(Array.isArray(s.correct)?  s.correct  : []);
    awardedLines = new Set(Array.isArray(s.awardedLines)? s.awardedLines : []);
    return true;
  }catch(e){ return false; }
}
function clearState(){ try{ localStorage.removeItem(LS_KEY(QUIZ_ID)); }catch(e){} }

/* ========= Elements ========= */
const board = document.getElementById('board');
const lifeChip = document.getElementById('lifeChip');
const xpChip = document.getElementById('xpChip');
const lineChip = document.getElementById('lineChip');
const barFill = document.getElementById('barFill');
const progLabel = document.getElementById('progLabel');

const finishCard = document.getElementById('finishCard');
const finishTitle = document.getElementById('finishTitle');
const finishStats = document.getElementById('finishStats');

const resumeToast = document.getElementById('resumeToast');
const leaveToast = document.getElementById('leaveToast');

/* Modal refs */
const qModalEl = document.getElementById('qModal');
const qModal = new bootstrap.Modal(qModalEl, { backdrop: 'static', keyboard: false });
const qModalContent = document.getElementById('qModalContent');
const modalHeaderClose = document.getElementById('modalHeaderClose');

const modalCellTitle = document.getElementById('modalCellTitle');
const modalTypeBadge = document.getElementById('modalTypeBadge');
const modalPrompt = document.getElementById('modalPrompt');
const modalMCQ = document.getElementById('modalMCQ');
const modalShort = document.getElementById('modalShort');
const modalLong = document.getElementById('modalLong');
const modalShortInput = document.getElementById('modalShortInput');
const modalLongInput = document.getElementById('modalLongInput');
const modalLongHelper = document.getElementById('modalLongHelper');
const modalRequiredWrap = document.getElementById('requiredWords');
const modalFeedback = document.getElementById('modalFeedback');
const modalExplain  = document.getElementById('modalExplain');
const modalLockHint = document.getElementById('modalLockHint');
const modalClearBtn = document.getElementById('modalClearBtn');
const modalCheckBtn = document.getElementById('modalCheckBtn');
const modalCloseBtn = document.getElementById('modalCloseBtn');

/* Game Over modal refs */
const overModalEl  = document.getElementById('overModal');
const overModal    = new bootstrap.Modal(overModalEl, { backdrop:'static', keyboard:false });
const overStats    = document.getElementById('overStats');
const overSolved   = document.getElementById('overSolved');
const overLines    = document.getElementById('overLines');
const overXP       = document.getElementById('overXP');
const overRetryBtn = document.getElementById('overRetryBtn');

/* ========= Helpers ========= */
function typeMeta(t){
  if (t==='mcq')   return {label:'MCQ', title:'Multiple Choice', icon:'bi-check2-square', badge:'badge-type'};
  if (t==='short') return {label:'SHORT', title:'Short Answer',   icon:'bi-input-cursor-text', badge:'badge-type'};
  return {label:'LONG', title:'Open-ended', icon:'bi-pencil-square', badge:'badge-type'};
}
function requiredWords(q){
  let req = (q.extra_parsed && Array.isArray(q.extra_parsed.required_words)) ? q.extra_parsed.required_words : [];
  if (!req.length && q.correct){ try{ const parsed = JSON.parse(q.correct); if (Array.isArray(parsed)) req = parsed; }catch(e){} }
  return (req || []).map(String).filter(Boolean);
}
function formatPrompt(s){ return escapeHtml(s||'').replace(/\n/g,'<br>'); }
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,(m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
function normalize(s){ return String(s||'').trim().toLowerCase(); }
function getBestExplain(q){
  const ex = (q && q.extra_parsed) ? q.extra_parsed : {};
  const exp = (typeof ex.explanation === 'string' && ex.explanation.trim()) ? ex.explanation.trim() : '';
  const hint = (typeof ex.hint === 'string' && ex.hint.trim()) ? ex.hint.trim() : '';
  return exp || hint || '';
}
function isBoardActive(){ return !finished && lives > 0 && answered.size < TOTAL; }

/* word-boundary contains check (client mirror of server) */
function containsAllWords(text, words){
  const cand = " " + normalize(text) + " ";
  return words.every(w=>{
    const needle = normalize(w);
    const re = new RegExp(`(^|[\\s\\W])${needle.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')}(?:$|[\\s\\W])`);
    return re.test(cand);
  });
}
function whichWordsHit(text, words){
  const cand = " " + normalize(text) + " ";
  return words.map(w=>{
    const needle = normalize(w);
    const re = new RegExp(`(^|[\\s\\W])${needle.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')}(?:$|[\\s\\W])`);
    return re.test(cand);
  });
}

/* ===== JS access to current level colors ===== */
function levelColors(){
  const cs = getComputedStyle(document.body);
  const get = (n)=> cs.getPropertyValue(n).trim() || '#6d8bff';
  return [ get('--c-blue'), get('--c-sky'), get('--c-sun'), get('--c-mint'), get('--c-rose'), get('--c-grape') ];
}

/* Reset board */
function resetBoard(){
  lives = 3; xp = 0; lines = 0; finished = false;
  selectedPos = null; answered = new Set(); correct = new Set(); awardedLines = new Set();
  finishCard.style.display = 'none';
  renderBoard(); updateHUD(); clearState();
}
overRetryBtn.addEventListener('click', ()=>{ overModal.hide(); resetBoard(); });

/* ========= Render Board ========= */
function renderBoard(){
  board.innerHTML = '';
  for (let i=0;i<TOTAL;i++){
    const q = QUESTIONS[i];
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.pos = i;

    if (q?.qtype === 'short') cell.classList.add('type-short');
    if (q?.qtype === 'long')  cell.classList.add('type-long');

    if (!q){
      cell.innerHTML = `<div class="inner"><div class="face front">
        <div class="text-center text-secondary">Loading…</div>
      </div></div>`;
      cell.classList.add('locked');
      board.appendChild(cell);
      continue;
    }

    const m = typeMeta(q.qtype);
    cell.innerHTML = `
      <div class="inner">
        <div class="face front">
          <div class="text-center">
            <div class="type-emblem em-${q.qtype}">
              <i class="bi ${m.icon}"></i> <span>${m.label}</span>
            </div>
            <div class="front-cta">Tap to open</div>
          </div>
        </div>
        <div class="face back">
          <div><i class="bi bi-question-circle me-1"></i> Ready?</div>
        </div>
      </div>
    `;

    if (correct.has(i)) { cell.classList.add('correct','locked'); cell.insertAdjacentHTML('beforeend','<span class="badge-done">✓</span>'); }
    else if (answered.has(i)) { cell.classList.add('wrong','locked'); cell.insertAdjacentHTML('beforeend','<span class="badge-done">✗</span>'); }
    if (lives <= 0) cell.classList.add('locked');

    cell.addEventListener('click', ()=>{
      if (lives <= 0) return;
      if (answered.has(i) || finishCard.style.display !== 'none') return;
      selectedPos = i;
      cell.classList.add('flipped');
      setTimeout(()=> openModalFor(i), 300);
    });

    board.appendChild(cell);
  }
}

/* ========= Modal ========= */
function hideAllModalBlocks(){ modalMCQ.style.display='none'; modalShort.style.display='none'; modalLong.style.display='none'; modalRequiredWrap.innerHTML=''; }

function renderRequiredChips(words, highlightHits=null){
  modalRequiredWrap.innerHTML = '';
  if (!words.length){ modalRequiredWrap.style.display='none'; return; }
  modalRequiredWrap.style.display='flex';
  words.forEach((w, idx)=>{
    const chip = document.createElement('span');
    chip.className = 'req-chip';
    if (Array.isArray(highlightHits)){
      chip.classList.add(highlightHits[idx] ? 'hit' : 'miss');
    }
    chip.innerHTML = `<span class="dot"></span><span>${escapeHtml(w)}</span>`;
    modalRequiredWrap.appendChild(chip);
  });
}

function openModalFor(pos){
  if (lives <= 0) return;
  const q = QUESTIONS[pos]; if (!q) return;

  const m = typeMeta(q.qtype);
  modalCellTitle.textContent = `Cell ${pos+1}`;
  modalTypeBadge.textContent = m.title;
  modalTypeBadge.className = `ms-3 ${m.badge}`;

  // Header close button only appears after answer/lock
  modalHeaderClose.style.display = 'none';
  modalHeaderClose.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); };

  modalPrompt.innerHTML = formatPrompt(q.prompt||'');
  modalFeedback.innerHTML = '';
  modalExplain.style.display = 'none';
  modalExplain.textContent = '';

  const isSolved   = correct.has(pos);
  const isAnswered = answered.has(pos);
  modalLockHint.style.display = isAnswered ? 'block' : 'none';
  hideAllModalBlocks();

  if (q.qtype==='mcq'){
    modalMCQ.style.display='block';
    modalMCQ.innerHTML='';
    [q.choice_a, q.choice_b, q.choice_c, q.choice_d].forEach((text,i)=>{
      const b = document.createElement('button');
      b.type='button'; b.className='option-btn w-100 text-start';
      b.innerHTML = `<span class="text-secondary me-2">${['A','B','C','D'][i]}.</span> ${escapeHtml(text||'')}`;
      b.addEventListener('click', ()=>{
        if (answered.has(pos)) return;
        [...modalMCQ.children].forEach(x=>x.classList.remove('sel'));
        b.classList.add('sel');
      });
      if (isAnswered) b.disabled = true;
      modalMCQ.appendChild(b);
    });

    if (isAnswered){
      const corrIx = ['A','B','C','D'].indexOf(String(q.correct||'').toUpperCase());
      [...modalMCQ.children].forEach((btn,idx)=>{
        btn.disabled = true;
        if (idx === corrIx) btn.classList.add('correct');
        else btn.classList.add('opacity-50');
      });
      const ex = getBestExplain(q);
      if (ex){
        modalExplain.style.display = 'block';
        modalExplain.innerHTML = `<div class="explain-block"><div class="explain-title">Answer explanation</div><div class="explain-body">${escapeHtml(ex)}</div></div>`;
      }
      modalHeaderClose.style.display = '';
    }

  } else if (q.qtype==='short'){
    modalShort.style.display='block';
    modalShortInput.value = '';
    modalShortInput.disabled = isAnswered;
    if (isAnswered){
      const ex = getBestExplain(q);
      if (ex){
        modalExplain.style.display = 'block';
        modalExplain.innerHTML = `<div class="explain-block"><div class="explain-title">Answer explanation</div><div class="explain-body">${escapeHtml(ex)}</div></div>`;
      }
      modalHeaderClose.style.display = '';
    }

  } else { // long (open-ended + required words)
    modalLong.style.display='block';
    modalLongInput.value = '';
    modalLongInput.disabled = isAnswered;

    const req = requiredWords(q);
    renderRequiredChips(req);

    // Live feedback as the user types (optional preview for chips)
    function liveUpdate(){
      const hits = whichWordsHit(modalLongInput.value, req);
      renderRequiredChips(req, hits);
    }
    modalLongInput.oninput = liveUpdate;

    // Helper text tweak
    modalLongHelper.textContent = req.length
      ? `Include all required words: ${req.join(', ')}`
      : `Include all required words (case-insensitive).`;

    if (isAnswered){
      const ex = getBestExplain(q);
      if (ex){
        modalExplain.style.display = 'block';
        modalExplain.innerHTML = `<div class="explain-block"><div class="explain-title">Answer explanation</div><div class="explain-body">${escapeHtml(ex)}</div></div>`;
      }
      modalHeaderClose.style.display = '';
    }
  }

  if (isSolved) setFooter('solved');
  else if (isAnswered) setFooter('locked');
  else setFooter('default');

  qModal.show();
}

qModalEl.addEventListener('hidden.bs.modal', ()=>{
  const cell = board.querySelector(`.cell[data-pos="${selectedPos}"]`);
  if (cell && cell.classList.contains('flipped')) cell.classList.remove('flipped');
  modalFeedback.innerHTML = '';
  modalExplain.style.display = 'none';
  modalExplain.textContent = '';
});

qModalEl.addEventListener('keydown', (e)=>{
  const q = (selectedPos!==null) ? QUESTIONS[selectedPos] : null;
  if (!q) return;
  if (q.qtype==='mcq'){
    const n = parseInt(e.key,10);
    if (n>=1 && n<=4 && modalMCQ.children[n-1] && !answered.has(selectedPos)){
      modalMCQ.children[n-1].click();
    }
  }
  if (e.key==='Enter'){ e.preventDefault(); onModalCheck(); }
});

/* ========= API: submit answer ========= */
async function submitAnswerToServer(questionId, responseText){
  try{
    const payload = { quiz_id: QUIZ_ID, question_id: questionId, response: responseText };
    const res = await fetch('/api/quiz/answer', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
    });
    const data = await res.json();

    const prevLevel = PROFILE_LEVEL;
    const prevXP    = PROFILE_XP;

    if (typeof data.lives === 'number') lives = data.lives;
    if (typeof data.xp    === 'number') xp    = data.xp;
    if (typeof data.lines === 'number') lines = data.lines;
    if (Array.isArray(data.correct))     correct = new Set(data.correct);

    if (typeof data.user_level === 'number') PROFILE_LEVEL = data.user_level;
    if (typeof data.user_xp    === 'number') PROFILE_XP    = data.user_xp;

    if (data.explanation){
      modalExplain.style.display = 'block';
      modalExplain.innerHTML = `<div class="explain-block"><div class="explain-title">Answer explanation</div><div class="explain-body">${escapeHtml(data.explanation)}</div></div>`;
    }

    if (PROFILE_LEVEL > prevLevel || Math.floor(PROFILE_XP/100) > Math.floor(prevXP/100)){
      triggerLevelUp(PROFILE_LEVEL, PROFILE_XP);
    }

    return { ok: res.ok, data };
  }catch(err){
    console.error(err);
    return { ok:false, data:null };
  }
}

/* ========= Check ========= */
document.getElementById('modalClearBtn').addEventListener('click', ()=>{
  if (selectedPos===null) return;
  const q = QUESTIONS[selectedPos];
  if (q.qtype==='mcq') [...modalMCQ.children].forEach(c=> c.classList.remove('sel'));
  if (q.qtype==='short') modalShortInput.value = '';
  if (q.qtype==='long')  { modalLongInput.value  = ''; renderRequiredChips(requiredWords(q)); }
  modalFeedback.innerHTML = '';
  modalExplain.style.display = 'none';
  modalExplain.textContent = '';
});

document.getElementById('modalCheckBtn').addEventListener('click', onModalCheck);

async function onModalCheck(){
  if (lives <= 0 || selectedPos===null) return;
  const q = QUESTIONS[selectedPos]; if (!q || answered.has(selectedPos)) return;

  let responsePayload = '';
  let selectedIndex = -1;

  if (q.qtype === 'mcq'){
    selectedIndex = [...modalMCQ.children].findIndex(b=> b.classList.contains('sel'));
    if (selectedIndex<0) { modalFeedback.innerHTML = `<div class="alert alert-warning mb-2">Choose one option.</div>`; return; }
    responsePayload = ['A','B','C','D'][selectedIndex];
    [...modalMCQ.children].forEach(btn => btn.disabled = true);
  } else if (q.qtype === 'short'){
    const val = (modalShortInput.value || '').trim(); if (!val){ modalFeedback.innerHTML = `<div class="alert alert-warning mb-2">Type your answer.</div>`; return; }
    responsePayload = val;
  } else {
    const txt = (modalLongInput.value || '').trim(); if (!txt){ modalFeedback.innerHTML = `<div class="alert alert-warning mb-2">Write your sentence.</div>`; return; }
    responsePayload = txt;
  }

  const { ok, data } = await submitAnswerToServer(q.id, responsePayload);

  answered.add(selectedPos);

  let wasCorrect = false;
  if (data){
    if (typeof data.was_correct === 'boolean')      wasCorrect = data.was_correct;
    else if (typeof data.correct === 'boolean')     wasCorrect = data.correct;
    else if (Array.isArray(data.correct))           wasCorrect = data.correct.includes(selectedPos);
  }

  if (q.qtype === 'mcq'){
    [...modalMCQ.children].forEach((btn, idx)=>{
      const letter = ['A','B','C','D'][idx];
      btn.classList.remove('sel');
      if (wasCorrect){
        if (idx === selectedIndex) btn.classList.add('correct');
        else btn.classList.add('opacity-50');
      } else {
        if (idx === selectedIndex) btn.classList.add('wrong');
        if (String(letter).toUpperCase() === String(q.correct||'').toUpperCase()){
          btn.classList.add('correct');
        }
      }
    });
  }

  if (q.qtype === 'long'){
    // Update chips to show which words were present in the submitted text
    const req = requiredWords(q);
    const hits = whichWordsHit(responsePayload, req);
    renderRequiredChips(req, hits);
  }

  if (wasCorrect){
    correct.add(selectedPos);
    if (!modalFeedback.innerHTML){
      modalFeedback.innerHTML = `<div class="alert alert-success mb-0">Correct! +10 XP</div>`;
    }
    awardLinesIfAny();
    setFooter('solved');
  } else {
    if (!modalFeedback.innerHTML){
      modalFeedback.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger mb-2">Wrong. -1 life</div>`);
    }
    setFooter('locked');
    if (lives <= 0 || (data && data.game_over)){
      updateHUD(); renderBoard(); saveState();
      endBoard("Out of lives!");
      return;
    }
  }

  // once answered, allow closing
  modalHeaderClose.style.display = '';
  modalHeaderClose.onclick = ()=> qModal.hide();

  updateHUD();
  renderBoard();
  saveState();

  if (answered.size === TOTAL || correct.size === TOTAL){
    endBoard("Board completed!");
    setFooter('solved');
  }
}

/* ========= Lines / Confetti ========= */
function awardLinesIfAny(){
  const newLines = computeCompletedLines(correct);
  let newlyAwarded = 0;
  newLines.forEach(idx=>{ if (!awardedLines.has(idx)){ awardedLines.add(idx); newlyAwarded++; }});
  if (newlyAwarded>0){
    showToast();
    shootConfetti(28 + 12*newlyAwarded);
  }
}
function computeCompletedLines(setCorrect){
  const results = new Set();
  const lineDefs = [];
  for (let r=0;r<4;r++) lineDefs.push([4*r+0,4*r+1,4*r+2,4*r+3]);
  for (let c=0;c<4;c++) lineDefs.push([0*4+c,1*4+c,2*4+c,3*4+c]);
  lineDefs.push([0,5,10,15]); lineDefs.push([3,6,9,12]);
  lineDefs.forEach((L, idx)=>{ if (L.every(p=> setCorrect.has(p))) results.add(idx); });
  return results;
}

/* ========= HUD / Finish ========= */
function updateHUD(){
  const pct = Math.round((answered.size / TOTAL) * 100);
  barFill.style.width = pct + '%';
  progLabel.textContent = `(${answered.size}/${TOTAL} opened)`;
  lifeChip.innerHTML = `<i class="bi bi-heart-fill"></i> Lives ${Math.max(lives,0)}`;
  xpChip.innerHTML = `<i class="bi bi-stars"></i> Board XP ${xp}`;
  lineChip.innerHTML = `<i class="bi bi-grid-3x3"></i> Lines ${lines}`;

  elProfileLevel.textContent   = PROFILE_LEVEL;
  elProfileXPNow.textContent   = PROFILE_XP % 100;
  elProfileXPTotal.textContent = PROFILE_XP;

  if (answered.size === TOTAL && finishCard.style.display === 'none'){
    endBoard("All cells opened!");
  }
}
function endBoard(reason){
  if (reason && reason.toLowerCase().startsWith('out of lives')) {
    [...document.querySelectorAll('.cell')].forEach(c=> c.classList.add('locked'));
    try { qModal.hide(); } catch(e){}
    if (overStats) { overStats.textContent = `Solved: ${correct.size}/${TOTAL} • Lines: ${lines} • XP: ${xp}`; }
    if (overSolved) overSolved.textContent = `${correct.size}/${TOTAL}`;
    if (overLines)  overLines.textContent  = `${lines}`;
    if (overXP)     overXP.textContent     = `${xp}`;
    overModal.show();
    clearState();
    return;
  }
  finishCard.style.display='block';
  finishTitle.textContent = reason || "Board complete!";
  finishStats.textContent = `Solved: ${correct.size}/${TOTAL} • Lines: ${lines} • XP: ${xp}`;
  finished = true;
  clearState();
}

/* ========= Toast + Confetti ========= */
function showToast(){ const el = document.getElementById('toastLine'); el.style.display='block'; setTimeout(()=> el.style.display='none', 1500); }
function showResumeToast(){ resumeToast.style.display='block'; setTimeout(()=> resumeToast.style.display='none', 1400); }
function shootConfetti(n=30){
  const colors = levelColors();
  for (let i=0;i<n;i++){
    const p = document.createElement('div'); p.className = 'confetti';
    const size = 6 + Math.random()*10;
    p.style.width = size+'px'; p.style.height = (size*1.4)+'px';
    p.style.left = (Math.random()*100)+'vw';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.transform = `rotate(${Math.random()*360}deg)`; p.style.opacity = 0.95;
    document.body.appendChild(p);
    const fall = 800 + Math.random()*900; const xdrift = (Math.random()*2-1)*120;
    p.animate([{ transform:`translate(0,0) rotate(0deg)`, opacity:1 },
               { transform:`translate(${xdrift}px, ${window.innerHeight+80}px) rotate(720deg)`, opacity:0.9 }],
               { duration: fall, easing:'cubic-bezier(.2,.7,.2,1)' });
    setTimeout(()=> p.remove(), fall);
  }
}

/* Footer mode */
function setFooter(mode){
  if (mode === 'solved' || mode === 'locked'){
    modalClearBtn.style.display = 'none';
    modalCheckBtn.style.display = 'none';
    modalCloseBtn.style.display = 'inline-flex';
    modalClearBtn.disabled = true;
    modalCheckBtn.disabled = true;
    return;
  }
  modalClearBtn.style.display = 'inline-flex';
  modalCheckBtn.style.display = 'inline-flex';
  modalCloseBtn.style.display = 'none';
  modalClearBtn.disabled = false;
  modalCheckBtn.disabled = false;
}

/* ========= Backdrop click: toast + wiggle, keep modal open ========= */
let lastLeaveToast = 0;
function showLeaveToast(){
  const now = Date.now();
  if (now - lastLeaveToast < 1200) return;
  lastLeaveToast = now;
  if (!leaveToast) return;
  leaveToast.style.display = 'block';
  leaveToast.style.animation = 'slideUpFade .22s ease-out';
  qModalContent.classList.add('modal-wiggle');
  setTimeout(()=> qModalContent.classList.remove('modal-wiggle'), 380);
  clearTimeout(showLeaveToast._t1); clearTimeout(showLeaveToast._t2);
  showLeaveToast._t1 = setTimeout(()=>{ leaveToast.style.animation = 'fadeOut .6s ease-in forwards'; }, 1000);
  showLeaveToast._t2 = setTimeout(()=>{ leaveToast.style.display = 'none'; leaveToast.style.animation = ''; }, 1600);
}
document.addEventListener("click", (e) => {
  const isModalOpen = qModalEl.classList.contains("show");
  if (!isModalOpen) return;
  const modalContent = qModalEl.querySelector(".modal-content"); if (!modalContent) return;
  const clickedInsideContent = modalContent.contains(e.target);
  const clickedBackdrop     = qModalEl.contains(e.target) && !clickedInsideContent;
  if (clickedBackdrop && isBoardActive()) { showLeaveToast(); }
});

/* ========= Prevent header close until answered ========= */
modalHeaderClose.addEventListener('click', (e)=>{
  if (modalHeaderClose.style.display === 'none'){
    e.preventDefault(); e.stopPropagation();
    showLeaveToast();
  }
});

/* ========= Level Up ========= */
function triggerLevelUp(newLevel, totalXP){
  LAST_LEVEL = newLevel; LAST_XP = totalXP;
  updateHUD();
  document.getElementById('levelUpNumber').textContent = `Lv ${newLevel}`;
  document.getElementById('levelUpXP').textContent = totalXP;
  shootConfetti(90);
  (new bootstrap.Modal(document.getElementById('levelUpModal'), { backdrop:'static', keyboard:true })).show();
}

/* ========= Start ========= */
(function init(){
  const hadState = loadState();
  renderBoard(); updateHUD();
  if (lives <= 0) { endBoard("Out of lives!"); return; }
  if (hadState && (answered.size>0 || correct.size>0)) showResumeToast();
  window.addEventListener('beforeunload', saveState);
})();
</script>
</body>
</html>
