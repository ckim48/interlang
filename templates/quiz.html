<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Level {{ level }} • Bingo Quiz</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" sizes="32x32">
<link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}" sizes="180x180">

<style>
:root{
  /* SAME TOKENS AS PROFILE */
  --ink:#0e1b35; --muted:#4b5567; --bg:#ffffff; --bg-soft:#f7f9ff; --grid:#0e1b3514;
  --brand:#3b82f6; --accent:#8f9bff; --ring:#cfe2ff;
  --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;

  /* Dark board tokens (only for the game area) */
  --navy-900:#0b1220; --navy-800:#0e1730;
  --glass: rgba(19,27,46,.72);

  /* “point color” confetti dots etc. */
  --point1:#60a5fa; --point2:#a78bfa; --point3:#f59e0b; --point4:#22c55e; --point5:#38bdf8; --point6:#e879f9;
}

/* Page bg matches Profile */
html,body{height:100%}
body{
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  color:var(--ink); background:var(--bg);
  background-image:
    radial-gradient(36vmax 36vmax at 12% 6%, #eef4ff 0%, transparent 70%),
    radial-gradient(32vmax 32vmax at 88% 0%, #f3f6ff 0%, transparent 70%),
    radial-gradient(30vmax 30vmax at 10% 90%, #f7faff 0%, transparent 70%);
  background-attachment: fixed;
}

/* ======= LIGHT COMPONENTS (copied from Profile theme) ======= */
.pill{
  background:linear-gradient(180deg,#fff,#f3f7ff);
  color:#223357; border:1px solid #e6ecff; font-weight:800;
  border-radius:999px; padding:.38rem .8rem; display:inline-flex; align-items:center; gap:.5rem;
  box-shadow:0 6px 16px rgba(13,31,64,.06);
}
.card-glass{
  border:1px solid #e6ecff;
  background:linear-gradient(180deg,#fff,#f7faff);
  border-radius:18px; box-shadow:0 10px 28px rgba(13,31,64,.06);
}
.progress{ height:12px; background:#eef3ff; border:1px solid #e2ebff; border-radius:999px; overflow:hidden }
.progress-bar{
  background-image: linear-gradient(90deg, var(--brand), var(--accent));
  background-size: 200% 100%; animation: move 3s linear infinite;
}
@keyframes move{0%{background-position:0 0}100%{background-position:200% 0}}

.btn-ghost{border:1px solid #e2ebff; color:#0e1b35; background:#fff}
.btn-ghost:hover{border-color:#cfe2ff; background:#f7fbff}
.btn-gradient{ border:none; color:#07110a; font-weight:800; background-image:linear-gradient(90deg,#16a34a,#22c55e); }
.btn-gradient:hover{filter:brightness(1.05)}

.alert-success{background:#eafff3;border:1px solid #baf3d0;color:#0b3b22}
.alert-danger{background:#fff1f1;border:1px solid #ffd2d2;color:#7f1d1d}
.toastline{
  position:fixed; right:1rem; bottom:1rem; background:#eafff3; border:1px solid #baf3d0;
  padding:.65rem .9rem; border-radius:12px; box-shadow:0 8px 24px rgba(13,31,64,.10); z-index:9999; display:none; color:#0b3b22;
}

/* ======= DARK BOARD AREA (kept for drama) ======= */
.board-wrap{
  background: linear-gradient(180deg, rgba(20,26,44,.96), rgba(12,19,38,.98));
  border:1px solid rgba(255,255,255,.08); color:#e6eeff; border-radius:18px;
  box-shadow: 0 14px 50px rgba(4,10,28,.30);
}
.board{ display:grid; grid-template-columns:repeat(4, 1fr); gap:.9rem; }

/* Cells */
.cell{
  position:relative; min-height:140px; border-radius:18px; cursor:pointer; overflow:hidden;
  background:
    radial-gradient(600px 220px at 50% -40%, rgba(110,168,254,.18), transparent 60%),
    linear-gradient(180deg, rgba(22,32,65,.95), rgba(15,23,46,.96));
  border:1px solid rgba(255,255,255,.10);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, outline .12s ease;
  perspective: 900px; isolation: isolate;
}
.cell:hover{
  transform:translateY(-2px); box-shadow:0 16px 40px rgba(0,0,0,.35);
  outline: 2px solid rgba(99,102,241,.22);
}
.cell.correct{ border-color:#38d878; }
.cell.wrong{ border-color:#f08c8c; }
.cell.locked{ pointer-events:none; opacity:.92; }
.cell.locked:hover{ transform:none; box-shadow:none }
.cell::before{
  content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
  background: conic-gradient(from 180deg, rgba(143,155,255,.45), rgba(110,168,254,.45), rgba(143,155,255,.45));
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude;
  opacity:.30; animation: spin 9s linear infinite;
}
@keyframes spin{ to{ transform: rotate(1turn); } }

.cell .inner{ position:absolute; inset:0; transform-style: preserve-3d; transition: transform .45s cubic-bezier(.2,.7,.2,1); }
.cell.flipped .inner{ transform: rotateY(180deg); }
.face{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:1rem; backface-visibility:hidden; }

/* Front */
.face.front{ text-align:center; color:#dbe6ff; }
.type-emblem{
  display:inline-flex; align-items:center; gap:.75rem; padding:.65rem .9rem;
  border-radius:14px; font-weight:800; letter-spacing:.4px; font-size:1.05rem;
  color:#0d1430; background: linear-gradient(135deg, #dbeafe, #e0ecff);
  box-shadow: inset 0 0 0 1px rgba(16,33,67,.12), 0 8px 22px rgba(0,0,0,.28);
}
.em-mcq{ background:linear-gradient(135deg, #dbeafe, #e0ecff); color:#0b2a4c; }
.em-short{ background: linear-gradient(135deg, #f8d2ff, #ffbfe4); color:#2a0b4c; }
.em-long{ background:linear-gradient(135deg, #fef3c7, #fff2d7); color:#3f2504; }
.front-cta{ margin-top:.55rem; color:#cbd5e1; font-weight:600; opacity:.95; letter-spacing:.2px; font-size:.9rem; }

/* Back */
.face.back{ transform: rotateY(180deg); color:#dfe8ff; font-weight:700; font-size:1.1rem; }

/* result chip */
.cell .badge-done{
  position:absolute; bottom:.55rem; right:.55rem;
  background:rgba(255,255,255,.09); border:1px solid rgba(255,255,255,.15);
  border-radius:999px; padding:.25rem .55rem; font-size:.82rem; z-index:2; color:#fff;
}

/* Modal (light) */
.modal-content{
  background:linear-gradient(180deg,#fff,#f7faff);
  border:1px solid #e6ecff; color:var(--ink); border-radius:18px;
  box-shadow:0 20px 60px rgba(13,31,64,.18);
}
.modal-header{ border-bottom:1px solid #e6ecff; }
.modal-footer{ border-top:1px solid #e6ecff; }
.modal .form-text{ color:#4b5567 !important; }
.badge-type{ border-radius:999px; padding:.35rem .7rem; font-weight:800; letter-spacing:.3px; border:1px solid #e2ebff; }
.badge-mcq{ background:linear-gradient(180deg,#fff,#f3f7ff); color:#223357;}
.badge-short{ background:linear-gradient(180deg,#fff8e6,#fff3cc); color:#5e4300;}
.badge-long{ background:linear-gradient(180deg,#eef4ff,#e6eeff); color:#1f2b46;}

.option-btn{
  border:1px solid #e2ebff !important;
  background:linear-gradient(180deg,#fff,#f7faff) !important;
  color:#0e1b35 !important; padding:14px 16px !important; border-radius:14px !important;
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
}
.option-btn:hover{ transform:translateY(-2px); box-shadow:0 8px 24px rgba(13,31,64,.10) }
.option-btn.sel{ border-color:#cfe2ff!important; box-shadow:0 0 0 .25rem var(--ring) }
.option-btn.correct{ border-color:#38d878!important; background:linear-gradient(145deg, rgba(34,197,94,.10), transparent)!important; }
.option-btn.wrong{ border-color:#f08c8c!important; background:linear-gradient(145deg, rgba(248,113,113,.10), transparent)!important; }

.quiz-input{
  background:#fff; color:#0e1b35; border:1px solid #e2ebff; padding:14px 16px; border-radius:14px;
}
.quiz-input:focus{ border-color:#cfe2ff; box-shadow:0 0 0 .25rem var(--ring) }

/* HUD helper text */
.dim{ color:var(--muted) }

/* Confetti */
.confetti{ position:fixed; top:-10px; left:0; width:8px; height:12px; border-radius:2px; z-index:9999 }

/* Resume toast */
.resume-toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:1rem; background:#eef7ff; color:#0e1b35;
  border:1px solid #cfe2ff; border-radius:12px; padding:.6rem .9rem;
  box-shadow:0 8px 24px rgba(13,31,64,.10); display:none; z-index:9999;
}
</style>
</head>
<body>

{% include 'nav.html' %}

<div class="container pb-5 mt-4">
  <div class="card-glass p-3 mb-3">
    <div class="d-flex align-items-center gap-3 flex-wrap">
      <div class="me-auto d-flex align-items-center gap-2">
        <span class="pill" id="lifeChip"><i class="bi bi-heart-fill"></i> Lives 3</span>
        <span class="pill" id="xpChip"><i class="bi bi-stars"></i> XP 0</span>
        <span class="pill" id="lineChip"><i class="bi bi-grid-3x3"></i> Lines 0</span>
      </div>
      <div class="flex-grow-1" style="min-width:220px; max-width:420px;">
        <div class="small mb-1" style="color:#223357;">Progress <span id="progLabel"></span></div>
        <div class="progress"><div class="progress-bar" id="barFill" style="width:0%"></div></div>
      </div>
    </div>
  </div>

  <!-- Board -->
  <div class="board-wrap border-0 mb-3 p-3">
    <div class="board" id="board"></div>
  </div>

  <!-- Finish Card -->
  <div class="card-glass border-0 text-center mt-3" id="finishCard" style="display:none">
    <div class="card-body p-5">
      <h2 class="display-6 fw-800 mb-2" id="finishTitle"
          style="background:linear-gradient(90deg,#9ae6b4,#d1fae5);-webkit-background-clip:text;background-clip:text;color:transparent;">
        Board complete!
      </h2>
      <p id="finishStats" class="mb-4 text-secondary" style="color:#d0dbff !important;"></p>
      <div class="d-flex justify-content-center gap-2">
        <a class="btn btn-ghost px-4" href="{{ url_for('home') }}">Back to Home</a>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toastline" id="toastLine"><i class="bi bi-trophy me-1"></i> Line completed! +20 XP</div>
<div class="resume-toast" id="resumeToast"><i class="bi bi-clock-history me-1"></i> Resumed your saved board.</div>

<!-- Question Modal -->
<div class="modal fade" id="qModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header align-items-center">
        <h5 class="modal-title"><span id="modalCellTitle">Cell</span></h5>
        <span class="ms-3 badge-type badge-mcq" id="modalTypeBadge">Multiple Choice</span>
        <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-secondary mb-3" id="modalPrompt"></p>
        <div id="modalMCQ" class="vstack gap-2 mb-3" style="display:none"></div>
        <div id="modalShort" style="display:none">
          <input class="quiz-input w-100" id="modalShortInput" placeholder="Type your answer here..." />
        </div>
        <div id="modalLong" style="display:none">
          <textarea class="quiz-input w-100" rows="3" id="modalLongInput" placeholder="Write one clear sentence..."></textarea>
          <div class="form-text">Use every required word (case-insensitive).</div>
        </div>
        <div id="modalFeedback" class="mt-3"></div>
        <div id="modalLockHint" class="mt-2" style="display:none">
          <i class="bi bi-lock-fill me-1"></i> This cell is locked (already checked).
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" id="modalClearBtn" type="button">
          <i class="bi bi-eraser"></i> Clear
        </button>
        <button class="btn btn-gradient" id="modalCheckBtn" type="button">Check</button>
        <button class="btn btn-ghost" id="modalCloseBtn" type="button" data-bs-dismiss="modal" style="display:none">
          <i class="bi bi-x-circle me-2"></i> Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div class="modal fade" id="overModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header align-items-center">
        <h5 class="modal-title">
          <i class="bi bi-emoji-frown me-2"></i> Out of lives
        </h5>
        <button type="button" class="btn-close btn-close-white ms-auto" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0 text-secondary" id="overStats"></p>
      </div>
      <div class="modal-footer">
        <a class="btn btn-ghost" href="{{ url_for('home') }}">
          <i class="bi bi-house-door"></i> Home
        </a>
        <button class="btn btn-gradient" id="overRetryBtn" type="button">
          <i class="bi bi-arrow-repeat me-1"></i> Try again
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= Template data ========= */
const RAW = {{ qs|tojson }};
const QUIZ_ID = {{ quiz_id }};
const BOARD_SIZE = 4, TOTAL = 16;

/* ========= Build fixed-position map ========= */
const POSMAP = {};
for (const q of RAW){
  const p = (q.extra_parsed && typeof q.extra_parsed.pos === 'number') ? q.extra_parsed.pos : null;
  if (p!==null && p>=0 && p<16) POSMAP[p] = q;
}
const QUESTIONS = Array.from({length:16}, (_,i)=> POSMAP[i]);

/* ========= State (with persistence) ========= */
let lives = 3, xp = 0, lines = 0;
let selectedPos = null;
let answered = new Set();
let correct = new Set();
let awardedLines = new Set();

const LS_KEY = (id)=> `bingo_state_${id}`;
function exportState(){
  return {
    lives, xp, lines,
    answered: [...answered],
    correct:  [...correct],
    awardedLines: [...awardedLines],
    ts: Date.now()
  };
}
function saveState(){
  try{ localStorage.setItem(LS_KEY(QUIZ_ID), JSON.stringify(exportState())); }catch(e){}
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY(QUIZ_ID));
    if(!raw) return false;
    const s = JSON.parse(raw);
    if(!s || typeof s!=='object') return false;
    lives = Number.isFinite(s.lives)? s.lives : lives;
    xp    = Number.isFinite(s.xp)? s.xp : xp;
    lines = Number.isFinite(s.lines)? s.lines : lines;
    answered = new Set(Array.isArray(s.answered)? s.answered : []);
    correct  = new Set(Array.isArray(s.correct)?  s.correct  : []);
    awardedLines = new Set(Array.isArray(s.awardedLines)? s.awardedLines : []);
    return true;
  }catch(e){ return false; }
}
function clearState(){ try{ localStorage.removeItem(LS_KEY(QUIZ_ID)); }catch(e){} }

/* ========= Elements ========= */
const board = document.getElementById('board');
const lifeChip = document.getElementById('lifeChip');
const xpChip = document.getElementById('xpChip');
const lineChip = document.getElementById('lineChip');
const barFill = document.getElementById('barFill');
const progLabel = document.getElementById('progLabel');

const finishCard = document.getElementById('finishCard');
const finishTitle = document.getElementById('finishTitle');
const finishStats = document.getElementById('finishStats');

const resumeToast = document.getElementById('resumeToast');

/* Modal refs */
const qModalEl = document.getElementById('qModal');
const qModal = new bootstrap.Modal(qModalEl, { backdrop: 'static', keyboard: false });

const modalCellTitle = document.getElementById('modalCellTitle');
const modalTypeBadge = document.getElementById('modalTypeBadge');
const modalPrompt = document.getElementById('modalPrompt');
const modalMCQ = document.getElementById('modalMCQ');
const modalShort = document.getElementById('modalShort');
const modalLong = document.getElementById('modalLong');
const modalShortInput = document.getElementById('modalShortInput');
const modalLongInput = document.getElementById('modalLongInput');
const modalFeedback = document.getElementById('modalFeedback');
const modalLockHint = document.getElementById('modalLockHint');
const modalClearBtn = document.getElementById('modalClearBtn');
const modalCheckBtn = document.getElementById('modalCheckBtn');
const modalCloseBtn = document.getElementById('modalCloseBtn');

/* Game Over modal refs */
const overModalEl  = document.getElementById('overModal');
const overModal    = new bootstrap.Modal(overModalEl, { backdrop:'static', keyboard:false });
const overStats    = document.getElementById('overStats');
const overRetryBtn = document.getElementById('overRetryBtn');

/* ========= Helpers ========= */
function typeMeta(t){
  if (t==='mcq')   return {label:'MCQ', title:'Multiple Choice', icon:'bi-check2-square', badge:'badge-mcq'};
  if (t==='short') return {label:'SHORT', title:'Short Answer',   icon:'bi-input-cursor-text', badge:'badge-short'};
  return {label:'LONG', title:'Long Answer', icon:'bi-pencil-square', badge:'badge-long'};
}
function requiredWords(q){
  let req = (q.extra_parsed && Array.isArray(q.extra_parsed.required_words)) ? q.extra_parsed.required_words : [];
  if (!req.length && q.correct){
    try{ const parsed = JSON.parse(q.correct); if (Array.isArray(parsed)) req = parsed; }catch(e){}
  }
  return (req || []).map(String);
}
function containsWord(text, word){
  const esc = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const re = new RegExp(`\\b${esc}\\b`, 'i');
  return re.test(text);
}
function formatPrompt(s){ return escapeHtml(s||'').replace(/\n/g,'<br>'); }
function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,(m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function normalize(s){ return String(s||'').trim().toLowerCase(); }

/* Reset the board for retry */
function resetBoard(){
  lives = 3; xp = 0; lines = 0;
  selectedPos = null;
  answered = new Set();
  correct = new Set();
  awardedLines = new Set();
  finishCard.style.display = 'none';
  renderBoard();
  updateHUD();
  clearState();
}
overRetryBtn.addEventListener('click', ()=>{
  overModal.hide();
  resetBoard();
});

/* ========= Render Board ========= */
function renderBoard(){
  board.innerHTML = '';
  for (let i=0;i<TOTAL;i++){
    const q = QUESTIONS[i];
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.pos = i;

    if (!q){ // safety if any slot missing
      cell.innerHTML = `<div class="inner"><div class="face front">
        <div class="text-center text-secondary">Loading…</div>
      </div></div>`;
      cell.classList.add('locked');
      board.appendChild(cell);
      continue;
    }

    const m = typeMeta(q.qtype);
    cell.innerHTML = `
      <div class="inner">
        <div class="face front">
          <div class="text-center">
            <div class="type-emblem em-${q.qtype}">
              <i class="bi ${m.icon}"></i> <span>${m.label}</span>
            </div>
            <div class="front-cta">${m.title} • tap to open</div>
          </div>
        </div>
        <div class="face back">
          <div><i class="bi bi-question-circle me-1"></i> Ready?</div>
        </div>
      </div>
    `;

    if (correct.has(i)) {
      cell.classList.add('correct','locked');
      cell.insertAdjacentHTML('beforeend','<span class="badge-done">✓</span>');
    } else if (answered.has(i)) {
      cell.classList.add('wrong','locked');
      cell.insertAdjacentHTML('beforeend','<span class="badge-done">✗</span>');
    }

    cell.addEventListener('click', ()=>{
      if (answered.has(i) || finishCard.style.display !== 'none') return;
      selectedPos = i;
      cell.classList.add('flipped');
      setTimeout(()=> openModalFor(i), 300);
    });

    board.appendChild(cell);
  }
}

/* ========= Modal ========= */
function hideAllModalBlocks(){
  modalMCQ.style.display='none';
  modalShort.style.display='none';
  modalLong.style.display='none';
}

function openModalFor(pos){
  const q = QUESTIONS[pos]; if (!q) return;

  const m = typeMeta(q.qtype);
  modalCellTitle.textContent = `Cell ${pos+1}`;
  modalTypeBadge.textContent = m.title;
  modalTypeBadge.className = `ms-3 badge-type ${m.badge}`;

  modalPrompt.innerHTML = formatPrompt(q.prompt||'');
  modalFeedback.innerHTML = '';

  const isSolved   = correct.has(pos);
  const isAnswered = answered.has(pos);

  modalLockHint.style.display = isAnswered ? 'block' : 'none';

  hideAllModalBlocks();

  if (q.qtype==='mcq'){
    modalMCQ.style.display='block';
    modalMCQ.innerHTML='';
    [q.choice_a, q.choice_b, q.choice_c, q.choice_d].forEach((text,i)=>{
      const b = document.createElement('button');
      b.type='button'; b.className='option-btn w-100 text-start';
      b.innerHTML = `<span class="text-secondary me-2">${['A','B','C','D'][i]}.</span> ${escapeHtml(text||'')}`;
      b.addEventListener('click', ()=>{
        if (answered.has(pos)) return;
        [...modalMCQ.children].forEach(x=>x.classList.remove('sel'));
        b.classList.add('sel');
      });
      if (isAnswered) b.disabled = true;
      modalMCQ.appendChild(b);
    });

    if (isAnswered){
      const corrIx = ['A','B','C','D'].indexOf(String(q.correct||'').toUpperCase());
      [...modalMCQ.children].forEach((btn,idx)=>{
        btn.disabled = true;
        if (idx === corrIx) btn.classList.add('correct');
        else btn.classList.add('opacity-50');
      });
    }

  } else if (q.qtype==='short'){
    modalShort.style.display='block';
    modalShortInput.value = '';
    modalShortInput.disabled = isAnswered;

  } else {
    modalLong.style.display='block';
    modalLongInput.value = '';
    modalLongInput.disabled = isAnswered;
  }

  if (isSolved) setFooter('solved');
  else if (isAnswered) setFooter('locked');
  else setFooter('default');

  qModal.show();
}

qModalEl.addEventListener('hidden.bs.modal', ()=>{
  const cell = board.querySelector(`.cell[data-pos="${selectedPos}"]`);
  if (cell && cell.classList.contains('flipped')) cell.classList.remove('flipped');
  modalFeedback.innerHTML = '';
});

qModalEl.addEventListener('keydown', (e)=>{
  const q = (selectedPos!==null) ? QUESTIONS[selectedPos] : null;
  if (!q) return;
  if (q.qtype==='mcq'){
    const n = parseInt(e.key,10);
    if (n>=1 && n<=4 && modalMCQ.children[n-1] && !answered.has(selectedPos)){
      modalMCQ.children[n-1].click();
    }
  }
  if (e.key==='Enter'){ e.preventDefault(); onModalCheck(); }
});

/* ========= Check ========= */
document.getElementById('modalClearBtn').addEventListener('click', ()=>{
  if (selectedPos===null) return;
  const q = QUESTIONS[selectedPos];
  if (q.qtype==='mcq') [...modalMCQ.children].forEach(c=> c.classList.remove('sel'));
  if (q.qtype==='short') modalShortInput.value = '';
  if (q.qtype==='long') modalLongInput.value = '';
  modalFeedback.innerHTML = '';
});
document.getElementById('modalCheckBtn').addEventListener('click', onModalCheck);

// ===== Check handler (shows result, never auto-closes the modal) =====
function onModalCheck(){
  if (selectedPos===null) return;
  const q = QUESTIONS[selectedPos];
  if (!q || answered.has(selectedPos)) return;

  let ok = false;

  if (q.qtype === 'mcq'){
    const i = [...modalMCQ.children].findIndex(b=> b.classList.contains('sel'));
    if (i<0) return;
    const letter = ['A','B','C','D'][i];
    ok = (letter.toUpperCase() === (q.correct||'').toUpperCase());

    [...modalMCQ.children].forEach((btn,idx)=>{
      btn.disabled = true;
      if (!ok && idx===i) btn.classList.add('wrong');
      if (['A','B','C','D'][idx].toUpperCase() === (q.correct||'').toUpperCase()) btn.classList.add('correct');
      if (idx!==i && ['A','B','C','D'][idx].toUpperCase() !== (q.correct||'').toUpperCase()) btn.classList.add('opacity-50');
    });

  } else if (q.qtype === 'short'){
    const val = (modalShortInput.value || '').trim(); if (!val) return;
    ok = normalize(val) === normalize(q.correct||'');

  } else { // long
    const txt = (modalLongInput.value || '').trim(); if (!txt) return;
    const req = requiredWords(q);
    const missing = req.filter(w => !containsWord(txt, w));
    const tokenCount = txt.split(/\s+/).filter(Boolean).length;
    const minLen = Math.max(6, req.length + 2);
    ok = (missing.length === 0) && (tokenCount >= minLen);

    if (!ok){
      const missHtml = missing.length ? `<div class="small mt-1">Missing: <code>${missing.join('</code>, <code>')}</code></div>` : '';
      const lenHtml = tokenCount < minLen ? `<div class="small mt-1">Write at least ${minLen} words (you wrote ${tokenCount}).</div>` : '';
      modalFeedback.innerHTML = `<div class="alert alert-danger mb-0">Not quite. ${missHtml}${lenHtml}</div>`;
    }
  }

  answered.add(selectedPos);

  if (ok){
    correct.add(selectedPos);
    xp += 10;
    modalFeedback.innerHTML = `<div class="alert alert-success mb-0">Correct! +10 XP</div>`;
    awardLinesIfAny();
    setFooter('solved');  // swap to Close, keep modal open
  } else {
    lives--;
    modalFeedback.insertAdjacentHTML('afterbegin', `<div class="alert alert-danger mb-2">Wrong. -1 life</div>`);
    setFooter('locked');  // swap to Close, keep modal open
    if (lives <= 0){
      endBoard("Out of lives!");   // show Game Over popup
      return;
    }
  }

  updateHUD();
  renderBoard();
  saveState();

  // If board is done, show finish card but DO NOT hide the modal automatically.
  if (answered.size === TOTAL || correct.size === TOTAL){
    endBoard("Board completed!");
    setFooter('solved'); // keep Close visible
  }
}

/* ========= Lines / Confetti ========= */
function awardLinesIfAny(){
  const newLines = computeCompletedLines(correct);
  let newlyAwarded = 0;
  newLines.forEach(idx=>{
    if (!awardedLines.has(idx)){
      awardedLines.add(idx);
      newlyAwarded++;
    }
  });
  if (newlyAwarded>0){
    lines += newlyAwarded;
    xp += 20 * newlyAwarded;
    showToast();
    shootConfetti(28 + 12*newlyAwarded);
  }
}

function computeCompletedLines(setCorrect){
  const results = new Set();
  const lineDefs = [];
  for (let r=0;r<4;r++) lineDefs.push([4*r+0,4*r+1,4*r+2,4*r+3]); // rows
  for (let c=0;c<4;c++) lineDefs.push([0*4+c,1*4+c,2*4+c,3*4+c]); // cols
  lineDefs.push([0,5,10,15]);                                     // diag
  lineDefs.push([3,6,9,12]);                                      // diag
  lineDefs.forEach((L, idx)=>{ if (L.every(p=> setCorrect.has(p))) results.add(idx); });
  return results;
}

/* ========= HUD & Finish ========= */
function updateHUD(){
  const pct = Math.round((answered.size / TOTAL) * 100);
  barFill.style.width = pct + '%';
  progLabel.textContent = `(${answered.size}/${TOTAL} opened)`;
  lifeChip.innerHTML = `<i class="bi bi-heart-fill"></i> Lives ${Math.max(lives,0)}`;
  xpChip.innerHTML = `<i class="bi bi-stars"></i> XP ${xp}`;
  lineChip.innerHTML = `<i class="bi bi-grid-3x3"></i> Lines ${lines}`;

  if (answered.size === TOTAL && finishCard.style.display === 'none'){
    endBoard("All cells opened!");
  }
}

/* Modified endBoard to use popup when out of lives */
function endBoard(reason){
  // Popup flow for out-of-lives
  if (reason && reason.toLowerCase().startsWith('out of lives')) {
    // Lock the board
    [...document.querySelectorAll('.cell')].forEach(c=> c.classList.add('locked'));
    // Close question modal if open
    try { qModal.hide(); } catch(e){}
    // Fill stats + show popup
    overStats.textContent = `Solved: ${correct.size}/${TOTAL} • Lines: ${lines} • XP: ${xp}`;
    overModal.show();
    clearState();
    return;
  }

  // Default finish card for other reasons (e.g., board complete)
  finishCard.style.display='block';
  finishTitle.textContent = reason || "Board complete!";
  finishStats.textContent = `Solved: ${correct.size}/${TOTAL} • Lines: ${lines} • XP: ${xp}`;
  clearState();
}

/* ========= Toast + Confetti ========= */
function showToast(){
  const el = document.getElementById('toastLine');
  el.style.display='block';
  setTimeout(()=> el.style.display='none', 1500);
}
function showResumeToast(){
  resumeToast.style.display='block';
  setTimeout(()=> resumeToast.style.display='none', 1400);
}
function shootConfetti(n=30){
  const colors = ['#60a5fa','#a78bfa','#f59e0b','#22c55e','#e879f9','#38bdf8'];
  for (let i=0;i<n;i++){
    const p = document.createElement('div');
    p.className = 'confetti';
    const size = 6 + Math.random()*10;
    p.style.width = size+'px';
    p.style.height = (size*1.4)+'px';
    p.style.left = (Math.random()*100)+'vw';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.transform = `rotate(${Math.random()*360}deg)`;
    p.style.opacity = 0.9;
    document.body.appendChild(p);

    const fall = 800 + Math.random()*900;
    const xdrift = (Math.random()*2-1)*120;
    p.animate([
      { transform:`translate(0,0) rotate(0deg)`, opacity:1 },
      { transform:`translate(${xdrift}px, ${window.innerHeight+80}px) rotate(720deg)`, opacity:0.9 }
    ], { duration: fall, easing:'cubic-bezier(.2,.7,.2,1)' });

    setTimeout(()=> p.remove(), fall);
  }
}

/* ===== Footer state helper ===== */
function setFooter(mode){
  // mode: 'default' | 'locked' | 'solved'
  if (mode === 'solved'){
    modalClearBtn.style.display = 'none';
    modalCheckBtn.style.display = 'none';
    modalCloseBtn.style.display = 'inline-flex';
    modalClearBtn.disabled = true;
    modalCheckBtn.disabled = true;
    return;
  }
  if (mode === 'locked'){ // already answered (wrong or solved)
    modalClearBtn.style.display = 'none';
    modalCheckBtn.style.display = 'none';
    modalCloseBtn.style.display = 'inline-flex';
    modalClearBtn.disabled = true;
    modalCheckBtn.disabled = true;
    return;
  }
  // default (fresh question)
  modalClearBtn.style.display = 'inline-flex';
  modalCheckBtn.style.display = 'inline-flex';
  modalCloseBtn.style.display = 'none';
  modalClearBtn.disabled = false;
  modalCheckBtn.disabled = false;
}

/* ========= Start ========= */
(function init(){
  const hadState = loadState();
  renderBoard();
  updateHUD();
  if (hadState && (answered.size>0 || correct.size>0)) showResumeToast();

  // Save often & safely
  window.addEventListener('beforeunload', saveState);
})();
</script>
</body>
</html>
