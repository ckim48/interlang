<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Quiz Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" sizes="32x32">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}" sizes="180x180">

  <style>
    :root{
      --ink:#0e1b35; --muted:#4b5567; --bg:#ffffff; --bg-soft:#f7f9ff;
      --grid:#0e1b3514; --brand:#3b82f6; --accent:#8f9bff; --ring:#cfe2ff;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --chip:#fff; --chip-border:#e6ecff;
    }
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink); background:var(--bg);
      background-image:
        radial-gradient(36vmax 36vmax at 12% 6%, #eef4ff 0%, transparent 70%),
        radial-gradient(32vmax 32vmax at 88% 0%, #f3f6ff 0%, transparent 70%),
        radial-gradient(30vmax 30vmax at 10% 90%, #f7faff 0%, transparent 70%);
      background-attachment: fixed;
    }
    .page-header{
      background: linear-gradient(180deg, #ffffff, #f7faff);
      border: 1px solid #e6ecff; border-radius:20px; padding:24px;
      box-shadow: 0 18px 44px rgba(13,31,64,.08); position:relative;
    }
    .page-header::after{
      content:""; position:absolute; left:20px; right:20px; bottom:-1px; height:2px;
      background: linear-gradient(90deg, transparent, #cfe0ff, #e0e7ff, transparent);
      opacity:.9; border-radius:2px;
    }
    .kicker{
      display:inline-flex; align-items:center; gap:.45rem;
      padding:.28rem .6rem; border-radius:999px; font-weight:800; font-size:.78rem;
      color:#0e1b35; background:#fff; border:1px solid #e6ecff;
    }
    .kicker i{ color:var(--brand) }
    .progress{ height:12px; background:#eef3ff; border-radius:999px; overflow:hidden; border:1px solid #e2ebff; }
    .progress-bar{ background: linear-gradient(90deg, var(--brand), var(--accent)); color:#fff; font-size:.72rem; font-weight:800; letter-spacing:.2px; }
    .section-title{ font-weight:800; letter-spacing:.2px; font-size:clamp(18px,2.5vw,20px); color:#1f2b46; margin-bottom:.25rem; }
    .section-sub{ color:var(--muted); }
    .quiz-card{
      border: 1px solid #e6ecff; background: linear-gradient(180deg, #ffffff, #f7faff);
      border-radius:18px; box-shadow: 0 10px 28px rgba(13,31,64,.06);
      transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
      position:relative; overflow:hidden; height:100%;
    }
    .quiz-card::before{ content:""; position:absolute; left:0; top:0; bottom:0; width:6px; background: linear-gradient(180deg, var(--brand), var(--accent)); opacity:.9; }
    .quiz-card:hover{ transform: translateY(-3px); box-shadow: 0 16px 36px rgba(13,31,64,.10); border-color:#d9e6ff; }
    .quiz-card .card-title{ font-weight:800; color:#0e1b35; letter-spacing:.2px; }
    .badge-tone{ display:inline-flex; align-items:center; gap:.35rem; background: linear-gradient(180deg, var(--chip), #f3f7ff); color:#223357; border:1px solid var(--chip-border); font-weight:700; border-radius:999px; padding:.18rem .5rem; font-size:.72rem; }
    .meta{ color:#4b5567; }
    .btn-action{ font-weight:800; border-radius:12px; border:0; background: linear-gradient(90deg, var(--brand), var(--accent)); color:#0f1a33 !important; box-shadow: 0 8px 18px rgba(59,130,246,.20); text-decoration:none; }
    .btn-locked{ border-radius:12px; font-weight:800; background:linear-gradient(180deg,#fff,#f8faff); border:1px solid #e6ecff; color:#6b7280 !important; }
    .btn-locked:disabled{ opacity:1; }
    .lock-overlay{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg, #ffffffaa, #f7faffa); color:#1f2b46; font-weight:800; border-radius:18px; border:1px dashed #d9e6ff; backdrop-filter: blur(4px); }
    .kpi{ display:inline-flex; align-items:baseline; gap:.35rem; padding:.35rem .55rem; border-radius:12px; background:#fff; border:1px solid #e6ecff; color:#223357; font-weight:800; }
    .kpi b{ font-size:.95rem } .kpi small{ font-size:.72rem; font-weight:700; color:#60719a }
    .dim{ color:#60719a }
    .loading-overlay{ position: fixed; inset: 0; z-index: 99999; display: none; align-items: center; justify-content: center; flex-direction: column; background:
        radial-gradient(40vmax 40vmax at 20% 10%, rgba(238,244,255,.9), transparent 70%),
        radial-gradient(36vmax 36vmax at 80% 0%, rgba(243,246,255,.9), transparent 70%),
        radial-gradient(34vmax 34vmax at 10% 90%, rgba(247,250,255,.9), transparent 70%),
        rgba(255,255,255,.7); backdrop-filter: blur(6px); }
    .loading-card{ background: linear-gradient(180deg, #ffffff, #f7faff); border:1px solid #e6ecff; border-radius:18px; box-shadow: 0 18px 44px rgba(13,31,64,.12); padding:28px 26px; text-align:center; max-width: 420px; width: calc(100% - 32px); }
    .loading-title{ font-weight: 900; color:#0f1a33; letter-spacing:.2px; margin-top:12px; background: linear-gradient(90deg, var(--brand), var(--accent)); -webkit-background-clip:text; background-clip:text; color: transparent; }
    .loading-sub{ color:#4b5567; }
  </style>
</head>
<body>
  {% include 'nav.html' %}

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" aria-hidden="true" aria-live="polite">
    <div class="loading-card" role="status" aria-label="Preparing quiz">
      <div class="d-flex justify-content-center"><div class="spinner-border" role="img" aria-label="Loading"></div></div>
      <h2 class="h5 loading-title">Building your bingo board…</h2>
      <p class="loading-sub mb-0">It takes a moment to generate the quiz...</p>
    </div>
  </div>

  <div class="container pb-5 mt-4">
    <!-- Header -->
    <div class="page-header mb-4 d-flex flex-column flex-md-row align-items-md-center justify-content-between">
      <div class="pe-md-4">
        <span class="kicker"><i class="bi bi-magic" aria-hidden="true"></i> Quick start</span>
        <h1 class="h3 mb-1 mt-2" style="font-weight:800; letter-spacing:.2px; color:#0f1a33">
          Welcome, {{ username }}
        </h1>
        <div class="d-flex gap-2 mt-1" role="group" aria-label="User KPIs">
          <span class="kpi"><b>{{ user_level|default(1) }}</b><small>level</small></span>
          <span class="kpi"><b>{{ (user_xp|default(0)) % 100 }}</b><small>XP</small></span>
        </div>
      </div>

      <!-- XP Progress Bar -->
      <div class="mt-3 mt-md-0 w-100" style="max-width:420px;">
        {% set current_xp = (user_xp|default(0)) % 100 %}
        {% if (user_level|default(1)) < 5 %}
          <div class="small mb-2 dim">XP Progress ({{ current_xp }}/100)</div>
          <div class="progress" aria-label="XP Progress">
            <div class="progress-bar" role="progressbar"
                 style="width: {{ current_xp }}%;"
                 aria-valuenow="{{ current_xp }}" aria-valuemin="0" aria-valuemax="100">
              {{ current_xp }} XP
            </div>
          </div>
          <div class="small mt-1 text-end dim">{{ 100 - current_xp }} XP to Level {{ (user_level|default(1)) + 1 }}</div>
        {% else %}
          <div class="small mb-1 dim">Max Level Reached</div>
          <div class="h5 mb-0" style="color:#16a34a; font-weight:800">Expert</div>
        {% endif %}
      </div>
    </div>

    <!-- Level Selector -->
    <div class="mb-2">
      <h2 class="section-title">Choose a Bingo Board</h2>
      <div class="section-sub">Solve a 4×4 board (16 cells). Complete lines for bonus XP.</div>
    </div>

    <div class="row g-3">
      {% for lvl in range(1,6) %}
        {% set locked = (lvl > (user_level|default(1))) %}
        <div class="col-12 col-sm-6 col-lg-4">
          <div class="card quiz-card position-relative {% if locked %}card-locked{% endif %}">
            <div class="card-body d-flex flex-column">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="card-title mb-0">
                  Level {{ lvl }}
                  {% if lvl == 1 %}<span class="badge-tone ms-1">Beginner</span>{% endif %}
                  {% if lvl == 2 %}<span class="badge-tone ms-1">Novice</span>{% endif %}
                  {% if lvl == 3 %}<span class="badge-tone ms-1">Intermediate</span>{% endif %}
                  {% if lvl == 4 %}<span class="badge-tone ms-1">Advanced</span>{% endif %}
                  {% if lvl == 5 %}<span class="badge-tone ms-1">Expert</span>{% endif %}
                </h5>
                {% if locked %}
                  <i class="bi bi-lock-fill" style="color:var(--bad);" aria-label="Locked"></i>
                {% else %}
                  <i class="bi bi-unlock" style="color:var(--ok);" aria-label="Unlocked"></i>
                {% endif %}
              </div>

              <div class="meta mb-3">4×4 Bingo • 16 cells • 3 lives</div>

              <div class="d-grid d-sm-flex gap-2 mt-auto">
                {% if locked %}
                  <button class="btn btn-locked w-100" disabled aria-disabled="true">
                    <i class="bi bi-lock-fill me-1" aria-hidden="true"></i> Locked
                  </button>
                {% else %}
                  <a class="btn btn-action start-quiz-btn flex-fill"
                     href="{{ url_for('start_quiz', level=lvl) }}"
                     data-level="{{ lvl }}"
                     role="button" aria-label="Continue Level {{ lvl }}">
                    <i class="bi bi-play-fill me-1" aria-hidden="true"></i> Continue
                  </a>
                  <a class="btn btn-outline-danger new-quiz-btn flex-fill"
                     href="{{ url_for('start_quiz', level=lvl) }}?new=1"
                     data-level="{{ lvl }}"
                     role="button" aria-label="Start new quiz for Level {{ lvl }}">
                    <i class="bi bi-arrow-repeat me-1" aria-hidden="true"></i> New Quiz
                  </a>
                {% endif %}
              </div>
            </div>

            {% if locked %}
              <div class="lock-overlay" aria-hidden="true">Reach Level {{ lvl }} to unlock</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function(){
    const overlay = document.getElementById('loadingOverlay');
    let navByButton = false;
    function showOverlay(){ if(overlay){ overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); } }
    function hideOverlay(){ if(overlay){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); } }

    document.addEventListener('click', function(e){
      const a = e.target.closest('.start-quiz-btn, .new-quiz-btn');
      if (!a) return;
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button === 1) return;
      e.preventDefault();
      a.classList.add('disabled');
      a.setAttribute('aria-disabled','true');
      a.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Preparing…';

      if (a.classList.contains('new-quiz-btn')) {
        try { Object.keys(localStorage).forEach(k => { if (k.startsWith('bingo_state_')) localStorage.removeItem(k); }); } catch(_) {}
      }

      navByButton = true;
      if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) { showOverlay(); }
      setTimeout(()=> { window.location.href = a.getAttribute('href'); }, 50);
    }, false);

    window.addEventListener('beforeunload', function(){ if (navByButton) showOverlay(); });
    window.addEventListener('pageshow', function(){ hideOverlay(); });
    document.addEventListener('DOMContentLoaded', hideOverlay);
  })();
  </script>
</body>
</html>
