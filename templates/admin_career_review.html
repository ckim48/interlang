<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Review • CareerQuest</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --ring:#e9eefc; --ink:#0e1b35; --muted:#59627e;
      --ok:#16a34a; --warn:#d97706; --pending:#64748b;
    }
    body{ background:#f6f9ff; color:var(--ink); }
    .page{ max-width: 1100px; }
    .card-soft{
      background:linear-gradient(180deg,#ffffff,#f8fbff);
      border:1px solid var(--ring);
      border-radius:18px; box-shadow:0 12px 32px rgba(20,40,80,.08);
    }
    .pill{
      display:inline-flex; align-items:center; gap:.35rem;
      padding:.25rem .6rem; border-radius:999px; font-weight:700;
      border:1px solid var(--ring); background:#fff; color:#21335c;
    }
    .stat .num{ font-weight:900; font-size:1.2rem; }
    .badge-soft{ background:#eef3ff; color:#3a53c6; }
    .status-reviewed{ background:#eaf8ef; color:#0e5e33; border:1px solid #cdebd8; }
    .status-pending{ background:#eef2f8; color:#2a3a5e; border:1px solid #dfe6f4; }
    .row-gap{ row-gap: .75rem; }
    .search-inp{ border-radius:12px; }
    .table > :not(caption) > * > * { vertical-align: middle; }
    .action-btns .btn{ border-radius:10px; }
    .json-pre{
      background:#0b1220; color:#e6edf3; border-radius:12px; padding:12px;
      font-size:.875rem; max-height:50vh; overflow:auto;
    }
  </style>
</head>
<body>
  {% include 'nav.html' %}

  <div class="container page my-4">
    <!-- Header -->
    <div class="card-soft p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h5 mb-1">CareerQuest • Review</h1>
          <div class="text-secondary small">
            WS #{{ ws.id }} • Owner: {{ ws.username }} • Week {{ week }}
          </div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <span class="pill"><span class="badge-soft rounded-pill">WS</span> {{ ws.id }}</span>
          <span class="pill"><span class="badge-soft rounded-pill">Week</span> {{ week }}</span>
        </div>
      </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{cat}}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {% set total = subs|length %}
    {% set reviewed = (subs | selectattr('score','ne', none) | list | length) %}
    {% set pending = total - reviewed %}

    <!-- Top toolbar -->
    <div class="card-soft p-3 mb-3">
      <div class="row align-items-end row-gap">
        <div class="col-md-7">
          <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-outline-secondary btn-sm" data-filter="all">All ({{ total }})</button>
            <button class="btn btn-outline-success btn-sm" data-filter="reviewed">Reviewed ({{ reviewed }})</button>
            <button class="btn btn-outline-dark btn-sm" data-filter="pending">Pending ({{ pending }})</button>
          </div>
        </div>
        <div class="col-md-5">
          <label class="form-label small mb-1">Search by student</label>
          <input id="searchBox" class="form-control form-control-sm search-inp" placeholder="Type a username…">
        </div>
      </div>
    </div>

    {% if total == 0 %}
      <div class="alert alert-info">No submissions for this week yet.</div>
    {% else %}

    <!-- Summary stats -->
    <div class="row g-2 mb-3">
      <div class="col-sm-4">
        <div class="card-soft p-3 stat text-center">
          <div class="text-secondary small">Submissions</div>
          <div class="num">{{ total }}</div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card-soft p-3 stat text-center">
          <div class="text-secondary small">Reviewed</div>
          <div class="num">{{ reviewed }}</div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card-soft p-3 stat text-center">
          <div class="text-secondary small">Pending</div>
          <div class="num">{{ pending }}</div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card-soft p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="reviewTable">
          <thead class="table-light">
            <tr>
              <th style="width:18%">Student</th>
              <th style="width:18%">Submitted</th>
              <th style="width:14%">Status</th>
              <th style="width:12%">Score</th>
              <th>Comment</th>
              <th style="width:20%">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in subs %}
            <tr
              class="review-row"
              data-username="{{ s.username|lower }}"
              data-status="{{ 'reviewed' if s.score is not none else 'pending' }}"
            >
              <td class="fw-semibold">{{ s.username }}</td>
              <td class="text-secondary small">{{ s.submitted_at }}</td>
              <td>
                {% if s.score is not none %}
                  <span class="badge status-reviewed">Reviewed</span>
                {% else %}
                  <span class="badge status-pending">Pending</span>
                {% endif %}
              </td>
              <td>
                {% if s.score is not none %}
                  <span class="badge bg-success">{{ s.score }}/100</span>
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="text-truncate" style="max-width: 260px;">
                {{ (s.comment or '') if s.comment else '—' }}
              </td>
              <td class="action-btns">
                <div class="d-flex gap-2 flex-wrap">
                  <!-- View answers (offcanvas) -->
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#answersCanvas"
                    data-username="{{ s.username }}"
                    data-submitted="{{ s.submitted_at }}"
                    data-answers='{{ (s.answers_json or "{}")|safe }}'
                  >
                    View answers
                  </button>

                  <!-- Go review/edit -->
                  <button
                    class="btn btn-primary btn-sm"
                    data-bs-toggle="collapse"
                    data-bs-target="#reviewForm{{ s.submission_id }}"
                    aria-expanded="false"
                  >
                    {% if s.score is not none %}Edit review{% else %}Review{% endif %}
                  </button>
                </div>
              </td>
            </tr>

            <!-- Inline review form -->
            <tr class="bg-light collapse" id="reviewForm{{ s.submission_id }}">
              <td colspan="6">
                <form class="p-3 border rounded" method="post" action="{{ url_for('admin_save_review', submission_id=s.submission_id) }}">
                  <div class="row g-3">
                    <div class="col-sm-3">
                      <label class="form-label">Score (0–100)</label>
                      <input type="number" name="score" min="0" max="100" step="1"
                             class="form-control" value="{{ s.score if s.score is not none }}">
                    </div>
                    <div class="col-sm-9">
                      <label class="form-label">Comment</label>
                      <textarea name="comment" class="form-control" rows="2" placeholder="Short feedback">{{ s.comment or '' }}</textarea>
                    </div>
                  </div>
                  <div class="mt-2">
                    <button class="btn btn-success btn-sm" type="submit">Save</button>
                  </div>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% endif %}
  </div>

  <!-- Offcanvas: answers viewer -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="answersCanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">Submission Answers</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <div class="mb-2 small text-secondary" id="ansMeta">—</div>
      <pre class="json-pre" id="ansJson">{}</pre>
      <div class="mt-2">
        <button id="copyJson" class="btn btn-outline-secondary btn-sm">Copy JSON</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  // Filters & search
  const table = document.getElementById('reviewTable');
  const rows  = Array.from(table?.querySelectorAll('tbody tr.review-row') || []);
  const searchBox = document.getElementById('searchBox');
  let activeFilter = 'all';

  function applyFilters(){
    const q = (searchBox.value || '').trim().toLowerCase();
    rows.forEach(r=>{
      const username = r.dataset.username || '';
      const status   = r.dataset.status || 'pending';
      const matchUser = !q || username.includes(q);
      const matchStatus = (activeFilter === 'all') || (status === activeFilter);
      r.style.display = (matchUser && matchStatus) ? '' : 'none';

      // also hide/show the collapse row right after it if present
      const next = r.nextElementSibling;
      if(next && next.matches('.collapse')) {
        if(r.style.display === 'none') next.classList.remove('show');
      }
    });
  }

  document.querySelectorAll('[data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      activeFilter = btn.getAttribute('data-filter');
      applyFilters();
    });
  });

  searchBox?.addEventListener('input', applyFilters);
  window.addEventListener('DOMContentLoaded', applyFilters);

  // Offcanvas answers viewer
  const canvasEl = document.getElementById('answersCanvas');
  const ansMeta  = document.getElementById('ansMeta');
  const ansJson  = document.getElementById('ansJson');
  canvasEl?.addEventListener('show.bs.offcanvas', (ev)=>{
    const btn = ev.relatedTarget;
    const username = btn?.getAttribute('data-username') || '—';
    const submitted = btn?.getAttribute('data-submitted') || '—';
    let raw = btn?.getAttribute('data-answers') || '{}';
    // pretty print
    try {
      const obj = typeof raw === 'string' ? JSON.parse(raw) : raw;
      ansJson.textContent = JSON.stringify(obj, null, 2);
    } catch(e){
      ansJson.textContent = raw || '{}';
    }
    ansMeta.textContent = `Student: ${username} • Submitted: ${submitted}`;
  });

  // Copy JSON
  document.getElementById('copyJson')?.addEventListener('click', ()=>{
    try{
      navigator.clipboard.writeText(ansJson.textContent || '{}');
    }catch(e){}
  });
  </script>
</body>
</html>
