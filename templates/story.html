<!-- templates/story.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ story.title or 'Story' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" sizes="32x32">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}" sizes="180x180">

  <style>
    :root{
      --ink:#2a2a2a; --muted:#667099;
      --paper:#fffdf5; --paper-edge:#f2eede;
      --paper-shadow:0 14px 40px rgba(244,170,90,.18), 0 4px 14px rgba(128,86,0,.08);
      --bg:#fff; --bg-wash-1:#fff7f1; --bg-wash-2:#f0f7ff; --bg-wash-3:#f7fff6;
      --ring:#ffdca8; --brand:#ff8db3; --brand-2:#7acbff; --brand-3:#7ee0a8; --brand-4:#ffd86b;
      --chip:#ffffff; --chip-br:#e8ecff;
      --nav-h:90px; --gutter:20px; --flip-ms:460ms; --arrow-pad:56px;
      --ok:#16a34a; --warn:#b45309; --danger:#b91c1c;
    }

    body{
      font-family: Nunito, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(60vmax 40vmax at 8% 0%, var(--bg-wash-2) 0%, transparent 65%),
        radial-gradient(60vmax 40vmax at 92% 4%, var(--bg-wash-1) 0%, transparent 65%),
        radial-gradient(36vmax 28vmax at 50% 100%, var(--bg-wash-3) 0%, transparent 70%),
        #fff;
      background-attachment: fixed;
    }
    .page-card{ border:1px solid #f1f2f7; background: linear-gradient(180deg,#ffffff,#fbfcff); border-radius:22px; box-shadow: 0 14px 42px rgba(34,45,89,.08); }

    /* ===== Book ===== */
    .book-wrap{ position: relative; background: linear-gradient(180deg,#fff,#fbfcff); border-radius: 24px; border:1px solid #f0f2fb; box-shadow: 0 26px 70px rgba(52,90,160,.10); overflow: hidden; max-width: 1200px; margin-inline: auto; }
    .book-stage{ position: relative; padding: 20px 14px 20px; perspective: 1600px; perspective-origin: 50% 40%; min-height: 64vh; }
    .spread{ position: relative; display: grid; grid-template-columns: minmax(280px, 1fr) var(--gutter) minmax(280px, 1fr); align-items: center; justify-items: center; min-height: 56vh; }
    .spine{ width: var(--gutter); border-radius: 12px; background: repeating-linear-gradient(180deg, #ffe7bb 0 6px, #ffdca8 6px 12px); border-left: 1px solid #ffd79b; border-right: 1px solid #ffe8c4; box-shadow: inset 0 0 18px rgba(255,174,53,.25); height: 100%; }
    .sheet{
      position: relative; background: var(--paper); color: var(--ink);
      border-radius: 16px; border:1px solid var(--paper-edge); box-shadow: var(--paper-shadow);
      padding: 28px var(--arrow-pad) 44px var(--arrow-pad);
      line-height: 1.9; font-size: 1.06rem; overflow: hidden;
      height: clamp(520px, 70vh, 82vh); aspect-ratio: 3 / 4;
      display:flex; flex-direction:column; justify-content:flex-start;
    }
    .sheet.left{ transform: rotate(-.15deg); } .sheet.right{ transform: rotate(.15deg); }
    .page-content{ position: relative; z-index: 1; }
    .page-number{ position:absolute; right:12px; bottom:10px; font-weight:900; font-size:.92rem; color:#6b7280; user-select:none; }

    /* Cover */
    .sheet.is-cover{ box-shadow: none; border: none; background: transparent; padding: 0; transform:none; }
    .sheet.is-cover .page-number{ display:none; }
    .sheet.is-cover .page-arrow.left{ display:none !important; }
    .cover{
      position: relative; height: 100%; display: grid; place-items: center; text-align: center;
      background:
        radial-gradient(600px 260px at 50% 28%, #fff0c8 0%, transparent 60%),
        radial-gradient(600px 280px at 20% 70%, #dffcff 0%, transparent 60%),
        radial-gradient(700px 280px at 80% 80%, #fef0ff 0%, transparent 60%);
    }
    .cover-inner{ width: 100%; height: 100%; display:flex; align-items:center; justify-content:center; flex-direction:column; padding: 24px; }
    .cover .kicker{ display:inline-block; padding:.35rem .85rem; border-radius:999px; border:1px dashed #ffd6a1; background:#fffaf0; font: 800 .8rem/1 Fredoka, Nunito, system-ui; color:#b4690e; letter-spacing:.08em; margin-bottom:1rem; }
    .cover .title{ font-family: Fredoka, Nunito, system-ui; font-weight:900; font-size: clamp(2.2rem, 4vw, 3rem); line-height:1.15; color:#111; text-shadow: 0 2px 0 #fff8; margin-bottom:.7rem; letter-spacing:.4px; max-width:90%; word-break:break-word; hyphens:auto; }
    .cover .rule{ width:180px; height:6px; margin:.6rem auto 0; border-radius: 6px; background: linear-gradient(90deg,#ffb6cf 0 33%, #9fe0ff 33% 66%, #aaf2c7 66% 100%); box-shadow: 0 6px 16px rgba(255,184,107,.35); }

    .word{ background: #fff0c7; border-bottom: 2px dashed #ffc36e; border-radius: 8px; padding: 0 .22rem; cursor: pointer; transition: background .12s ease, transform .06s ease; }
    .word:hover{ background: #ffe9b0; transform: translateY(-1px); }

    .page-arrow{
      position:absolute; top:50%; transform: translateY(-50%); display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:50%; border:1px solid #ffe6b8;
      background: radial-gradient(closest-side, #fff 64%, transparent), linear-gradient(180deg,#fff4d8,#ffe8b3);
      color:#8a5600; z-index: 2; font-size:1.15rem; box-shadow: 0 8px 22px rgba(255,184,107,.35);
    }
    .page-arrow:hover{ filter: brightness(1.03); transform: translateY(-50%) scale(1.03); }
    .page-arrow:disabled{ opacity:.5; cursor:not-allowed; }
    .page-arrow.left{ left: 12px; } .page-arrow.right{ right: 12px; }

    /* Flip overlay */
    .flip-layer{ position:absolute; inset:20px 14px 20px 14px; pointer-events:none; }
    .flip-sheet{ position:absolute; top:0; left:0; transform-style: preserve-3d; backface-visibility: hidden; will-change: transform; border-radius:16px; overflow:hidden; box-shadow: var(--paper-shadow); }
    .flip-face{ position:absolute; inset:0; background: var(--paper); color: var(--ink); border:1px solid var(--paper-edge); padding:28px var(--arrow-pad) 44px var(--arrow-pad); backface-visibility: hidden; }
    .flip-face.back{ transform: rotateY(180deg); }
    .shade{ content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none; opacity:.0; background: linear-gradient(90deg, rgba(255,195,110,.28), rgba(0,0,0,0)); }
    .flip-sheet.turning .shade{ opacity:.4; transition: opacity var(--flip-ms) ease; }
    @keyframes flip-forward { from { transform: rotateY(0deg); } to { transform: rotateY(-180deg); } }
    @keyframes flip-back    { from { transform: rotateY(0deg); } to { transform: rotateY(180deg); } }
    .animate-forward{ animation: flip-forward var(--flip-ms) ease both; }
    .animate-back{ animation: flip-back var(--flip-ms) ease both; }

    @media (max-width: 900px){
      .spread{ grid-template-columns: 1fr; }
      .spine{ display:none; }
      .sheet{ height: clamp(520px, 72vh, 84vh); aspect-ratio: 3 / 4; transform: none; }
      .flip-layer{ display:none; }
      .page-arrow{ top:auto; bottom:10px; transform:none; }
      .page-arrow.left{ left:10px; } .page-arrow.right{ right:10px; }
    }

    /* ===== Vocabulary strip + Quiz trigger ===== */
    .vocab-card{ border:1px dashed #ffe0b6; background: linear-gradient(180deg,#fffaf1,#fff); border-radius:20px; padding:14px; box-shadow: 0 12px 30px rgba(255,184,107,.16); }
    .vocab-chip{ border-radius:999px; border:1px solid var(--chip-br); background:#fff; color:#2a2a2a; font-weight:800; padding:.35rem .8rem; font-size:.9rem; box-shadow: 0 2px 0 #fff4d8, 0 10px 18px rgba(34,45,89,.06); transition: transform .08s ease, box-shadow .12s ease; }
    .vocab-chip:hover{ transform: translateY(-1px); box-shadow: 0 2px 0 #fff4d8, 0 16px 28px rgba(34,45,89,.10); }

    .btn-fun{ border-radius:12px; border:1px solid #ffdca8; background: linear-gradient(180deg,#fff6e7,#ffe8b3); color:#8a5600; font-weight:800; padding:.45rem .8rem; }
    .btn-fun:hover{ filter:brightness(1.03); }
    .btn-fun-outline{ border-radius:12px; border:1px dashed #ffdca8; background:#fff; color:#8a5600; font-weight:800; padding:.45rem .8rem; }
    .pill{ display:inline-block; padding:.18rem .6rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; color:#374151; font-size:.78rem; }
    .pill.ok{ border-color:#c7f0d2; background:#f0fff4; color:#14532d; }
    .pill.bad{ border-color:#ffd1d1; background:#fff7f7; color:#7f1d1d; }
    .pill.neutral{ border-color:#e5e7eb; background:#fff; color:#374151; }

    /* ===== Dictionary sheet (below navbar) ===== */
    .dict-sheet{
      position: fixed; top: calc(var(--nav-h) + 10px); right: -440px;
      width: 440px; max-width: 96%;
      height: calc(100vh - (var(--nav-h) + 10px));
      background: linear-gradient(180deg,#ffffff,#fffaf3);
      color:#2a2a2a; border-left:1px solid #ffe6bf;
      box-shadow: -20px 0 60px rgba(255,184,107,.35);
      transition: right .25s ease;
      z-index: 5000;
      display:flex; flex-direction:column; border-top-left-radius:16px;
    }
    .dict-sheet.open{ right:0; }
    .dict-header{ position: sticky; top:0; padding:14px 16px; border-bottom:1px dashed #ffe0b6; display:flex; align-items:center; justify-content:space-between; background: linear-gradient(180deg, #fff6e7, #fff); z-index:1; border-top-left-radius:16px; }
    .dict-body{ padding:16px; overflow:auto; }
    .dict-word{ font-family: Fredoka, Nunito; font-size:1.45rem; font-weight:900; letter-spacing:.2px; }
    .dict-sub{ color:#6d728d; }
    .muted{ color:#8a90a8; }

    /* ===== Quiz Modal (below navbar + extra padding) ===== */
    .modal-mask{
      position: fixed;
      top: calc(var(--nav-h) + 10px);
      left:0; right:0; bottom:0;
      background: rgba(15,23,42,.45);
      display:none;
      align-items:flex-start;
      justify-content:center;
      z-index: 4000;
      padding: 16px;
    }
    .modal-mask.open{ display:flex; }
    .modal-card{
      width: min(900px, 96vw); max-height: calc(88vh - 10px); overflow:auto; border-radius:20px;
      background: linear-gradient(180deg,#ffffff,#fffaf3); border:1px solid #ffe6bf; box-shadow: 0 30px 80px rgba(15,23,42,.25);
      padding: 8px;
    }
    .modal-head{
      position: sticky; top:0; display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:14px 16px; border-bottom:1px dashed #ffe0b6; background: linear-gradient(180deg, #fff6e7, #fff); z-index:5; border-top-left-radius:20px; border-top-right-radius:20px;
    }
    .modal-title{ font-family: Fredoka, Nunito; font-weight:900; letter-spacing:.2px; }
    .modal-body{ padding:20px; }
    .modal-foot{
      position: sticky; bottom:0; display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 16px; border-top:1px dashed #ffe0b6; background: linear-gradient(180deg,#fff,#fff6e7); z-index:5; border-bottom-left-radius:20px; border-bottom-right-radius:20px;
    }
    .quiz-meta{ color:#6b7280; font-size:.95rem; }
    .q-card{ border:1px solid #f1f2f7; background:#fff; border-radius:14px; padding:12px; margin-bottom:12px; box-shadow: 0 6px 18px rgba(34,45,89,.06); }
    .q-type{ font-size:.8rem; color:#64748b; font-weight:800; }
    .q-prompt{ font-weight:800; margin:.25rem 0 .35rem; }
    .opt-row{ display:flex; flex-direction:column; gap:6px; margin-top:.25rem; }
    .opt{ display:flex; align-items:center; gap:8px; border:1px solid #e7ecff; background:#fff; border-radius:10px; padding:.45rem .6rem; cursor:pointer; }
    .opt input{ accent-color:#ffb6cf; }
    .opt:hover{ background:#fff8fb; }
    .badge-lite{ display:inline-block; padding:.18rem .5rem; border-radius:999px; border:1px solid #ffe0b6; background:#fffaf1; color:#8a5600; font-weight:800; font-size:.78rem; }

    /* Kid-friendly praise card */
    .praise-card{
      border:1px dashed #ffdca8;
      background: linear-gradient(180deg,#fffaf1,#ffffff);
      border-radius:14px;
      padding:12px 14px;
      margin-top:10px;
      box-shadow: 0 8px 20px rgba(255,184,107,.18);
      font-weight:700;
      color:#5b4a1f;
    }
    .praise-small{ font-weight:600; color:#746a49; margin-top:4px; }
  </style>
</head>
<body>
  {% include 'nav.html' %}

  <div class="container pb-5 mt-4">
    <!-- Vocabulary + Quiz trigger -->
    <div class="page-card vocab-card p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-bold" style="font-family:Fredoka; letter-spacing:.2px;">
          <i class="bi bi-stars" style="color:#ff9cc8;"></i> Vocabulary from this story
        </div>
        <div class="d-flex align-items-center gap-2">
          <span id="quiz-status-pill" class="pill neutral">Quiz: not started</span>
          <button id="open-quiz" class="btn-fun"><i class="bi bi-ui-checks"></i> Story Quiz</button>
        </div>
      </div>
      <div class="small muted">Tap a word to see what it means.</div>
      <div class="d-flex flex-wrap gap-2 mt-2" id="vocab-chips">
        {% for w in vocab %}
          <button type="button" class="btn vocab-chip vocab-chip-btn" data-word="{{ w|e }}">{{ w }}</button>
        {% endfor %}
        {% if not vocab %}
          <div class="muted">No vocabulary extracted.</div>
        {% endif %}
      </div>
    </div>

    <!-- Book viewport -->
    <div class="page-card book-wrap" id="book">
      <div class="book-stage">
        <div class="spread" id="spread">
          <!-- LEFT PAGE -->
          <div class="sheet left" id="page-left" aria-live="polite">
            <div class="page-content" id="content-left"></div>
            <div class="page-number" id="pnum-left"></div>
            <button class="page-arrow left" id="prev-btn" aria-label="Previous"><i class="bi bi-chevron-left"></i></button>
          </div>

          <div class="spine" aria-hidden="true"></div>

          <!-- RIGHT PAGE -->
          <div class="sheet right" id="page-right" aria-live="polite">
            <div class="page-content" id="content-right"></div>
            <div class="page-number" id="pnum-right"></div>
            <button class="page-arrow right" id="next-btn" aria-label="Next"><i class="bi bi-chevron-right"></i></button>
          </div>

          <div class="flip-layer" id="flip-layer" aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <div class="small muted mt-2"><i class="bi bi-info-circle"></i> Click highlighted words on any page to open the dictionary.</div>
  </div>

  <!-- Dictionary sheet -->
  <div class="dict-sheet" id="dict-sheet" aria-hidden="true">
    <div class="dict-header">
      <div class="fw-bold" style="font-family:Fredoka;"><i class="bi bi-translate"></i> Dictionary</div>
      <div class="d-flex align-items-center gap-2">
        <input id="dict-input" class="form-control form-control-sm d-inline-block" style="width: 170px;" placeholder="Look up a word…" />
        <button id="dict-search" class="btn btn-sm btn-fun"><i class="bi bi-search"></i></button>
        <button id="dict-close" class="btn btn-sm btn-fun-outline"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="dict-body" id="dict-body"><div class="muted">Choose a word to see details.</div></div>
  </div>

  <!-- QUIZ MODAL -->
  <div class="modal-mask" id="quiz-modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="quiz-title">
      <div class="modal-head">
        <div class="modal-title" id="quiz-title"><i class="bi bi-ui-checks-grid"></i> Story Quiz</div>
        <div class="d-flex align-items-center gap-2">
          <span id="quiz-meta" class="quiz-meta">Loading…</span>
          <button id="quiz-close" class="btn-fun-outline" aria-label="Close"><i class="bi bi-x-lg"></i></button>
        </div>
      </div>
      <div class="modal-body">
        <div id="quiz-list"></div>
        <div id="quiz-result" class="mt-2" style="display:none;"></div>
      </div>
      <div class="modal-foot">

        <div class="d-flex align-items-center gap-2">
          <button id="quiz-regenerate" class="btn-fun-outline"><i class="bi bi-arrow-repeat"></i> Retake</button>
        </div>
                        <div id="quiz-alert" class="small muted mb-2">Answer all questions, then Submit.</div>

        <div class="d-flex align-items-center gap-2">
          <span id="quiz-progress" class="pill neutral">0 / 7</span>
          <button id="quiz-submit" class="btn-fun"><i class="bi bi-check2-circle"></i> Submit</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    /* ===== Layout helpers ===== */
    function setNavHeightVar(){
      const nav = document.querySelector('.navbar.fixed-top, nav.navbar.fixed-top');
      const h = nav ? Math.round(nav.getBoundingClientRect().height) : 56;
      document.documentElement.style.setProperty('--nav-h', h + 'px');
    }
    window.addEventListener('load', setNavHeightVar);
    window.addEventListener('resize', setNavHeightVar);

    /* ===== Data from server ===== */
    window.storyVocab = {{ (vocab or []) | tojson }};
    const rawContent  = {{ (content or '') | tojson }};
    const storyTitle  = {{ (story.title or '') | tojson }};
    const storySlug   = {{ (story.slug or '') | tojson }};

    /* ===== Utilities ===== */
    function escapeHTML(s){
      return (s||'').replace(/[&<>"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c]));
    }
    function highlightParagraph(el, words){
      const t = el.textContent || '';
      if(!t || !words || !words.length) return;
      const escaped = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
      const re = new RegExp("\\b(" + escaped.join("|") + ")\\b", "gi");
      el.innerHTML = t.replace(re, (m)=> `<span class="word" data-word="${m.toLowerCase()}">${m}</span>`);
    }

    /* ===== Split & paginate ===== */
    function splitParagraphs(text){
      const lines = (text||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
      let i = 0; while(i<lines.length && !lines[i].trim()) i++;
      if (lines[i] && storyTitle && lines[i].trim().toLowerCase() === storyTitle.trim().toLowerCase()) i++;
      if (lines[i] && /^title\s*:/i.test(lines[i].trim())) i++;
      const body = lines.slice(i).join('\n');
      const rawParas = body.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);
      const filtered = rawParas.filter(p => !/^title\s*:/i.test(p));
      return filtered;
    }

    function paginateIntoPages(paragraphs){
      const measure = document.createElement('div');
      measure.className = 'sheet';
      measure.style.position = 'absolute'; measure.style.visibility = 'hidden';
      measure.style.pointerEvents = 'none'; measure.style.left = '-9999px';
      document.body.appendChild(measure);

      const pages = [];
      let current = document.createElement('div');

      const pushPage = () => { pages.push({ html: current.innerHTML, noFolio: false }); current = document.createElement('div'); };
      const fitsAfterAppend = (node) => {
        measure.innerHTML = '';
        const clone = current.cloneNode(true);
        measure.appendChild(clone); measure.appendChild(node);
        return measure.scrollHeight <= measure.clientHeight;
      };

      for (const para of paragraphs){
        const pNode = document.createElement('p'); pNode.textContent = para;
        if (fitsAfterAppend(pNode)){ current.appendChild(pNode); continue; }

        const sentences = para.split(/(?<=[.!?])\s+/);
        let buf = '';
        for (let s=0; s<sentences.length; s++){
          const cand = buf ? (buf + ' ' + sentences[s]) : sentences[s];
          const test = document.createElement('p'); test.textContent = cand;
          if (fitsAfterAppend(test)){ buf = cand; }
          else{
            if (buf){ const full = document.createElement('p'); full.textContent = buf; current.appendChild(full); }
            pushPage(); buf = sentences[s];
          }
        }
        if (buf){
          const full = document.createElement('p'); full.textContent = buf;
          if (!fitsAfterAppend(full)){
            const words = buf.split(/\s+/);
            let wbuf = '';
            for (let w=0; w<words.length; w++){
              const c = wbuf ? (wbuf + ' ' + words[w]) : words[w];
              const test2 = document.createElement('p'); test2.textContent = c;
              if (fitsAfterAppend(test2)){ wbuf = c; }
              else{
                if (wbuf){ const wp = document.createElement('p'); wp.textContent = wbuf; current.appendChild(wp); }
                pushPage(); wbuf = words[w];
              }
            }
            if (wbuf){ const last = document.createElement('p'); last.textContent = wbuf; current.appendChild(last); }
          }else{ current.appendChild(full); }
        }
      }
      if (current.childNodes.length){ pages.push({ html: current.innerHTML, noFolio: false }); }
      document.body.removeChild(measure);
      return pages;
    }

    function buildCoverPlusFirst(contentPages){
      const leftCover = {
        html: `
          <div class="cover">
            <div class="cover-inner">
              <div class="kicker">STORYBOOK</div>
              <div class="title">${escapeHTML(storyTitle || 'Untitled Story')}</div>
              <div class="rule"></div>
            </div>
          </div>`,
        noFolio: true
      };
      if (contentPages.length === 0){ return [leftCover]; }
      const firstRight = { html: contentPages[0].html, noFolio: false };
      const rest = contentPages.slice(1);
      return [leftCover, firstRight, ...rest];
    }

    const paragraphs = splitParagraphs(rawContent);
    const vocabSet = Array.from(new Set((window.storyVocab||[]).map(w=>(w||'').toLowerCase()))).filter(Boolean);
    const contentPages = paginateIntoPages(paragraphs);
    const pages = buildCoverPlusFirst(contentPages);
    const totalPages = pages.length;

    /* ===== Book DOM ===== */
    const spreadLeft   = document.getElementById('page-left');
    const spreadRight  = document.getElementById('page-right');
    const contentLeft  = document.getElementById('content-left');
    const contentRight = document.getElementById('content-right');
    const pnumLeft     = document.getElementById('pnum-left');
    const pnumRight    = document.getElementById('pnum-right');
    const flipLayer    = document.getElementById('flip-layer');
    const prevBtn      = document.getElementById('prev-btn');
    const nextBtn      = document.getElementById('next-btn');

    function storageKey(slug){ return `story:${slug}:spread`; }
    function getSavedSpread(){
      try{ const v = parseInt(sessionStorage.getItem(storageKey(storySlug))); return isNaN(v)?1:v; }catch(_){ return 1; }
    }
    function saveSpread(s){ try{ sessionStorage.setItem(storageKey(storySlug), String(s)); }catch(_){} }

    function applyVocabHighlights(container){
      if (!vocabSet.length) return;
      container.querySelectorAll('p').forEach(p => highlightParagraph(p, vocabSet));
    }
    function setPageNumber(el, idx){ if (!el) return; el.textContent = idx; }
    function renderInto(side, pageIndex){
      const isLeft = (side === 'left');
      const pageObj = pages[pageIndex-1] || { html:'', noFolio:false };
      const contentEl = isLeft ? contentLeft : contentRight;
      const sheetEl   = isLeft ? spreadLeft  : spreadRight;
      const numEl     = isLeft ? pnumLeft    : pnumRight;

      const isCover = (pageIndex === 1);
      sheetEl.classList.toggle('is-cover', isCover);
      contentEl.innerHTML = pageObj.html || '';
      if (isCover){ numEl.textContent = ''; } else { setPageNumber(numEl, pageIndex); }
      if (isCover){ prevBtn.setAttribute('disabled','disabled'); } else { prevBtn.removeAttribute('disabled'); }
      applyVocabHighlights(contentEl);
    }

    let spread = Math.max(1, Math.min(Math.ceil(totalPages/2), getSavedSpread()));
    function showSpread(s){
      const maxSpread = Math.ceil(totalPages/2);
      spread = Math.max(1, Math.min(maxSpread, s));
      const leftIndex  = (spread-1)*2 + 1;
      const rightIndex = leftIndex + 1;
      spreadLeft.style.visibility  = (leftIndex  <= totalPages) ? 'visible' : 'hidden';
      spreadRight.style.visibility = (rightIndex <= totalPages) ? 'visible' : 'hidden';
      if (leftIndex  <= totalPages) renderInto('left',  leftIndex);
      if (rightIndex <= totalPages) renderInto('right', rightIndex);
      nextBtn.disabled = (spread >= Math.ceil(totalPages/2));
      saveSpread(spread);
    }
    function rectWithin(el, ancestor){
      const r = el.getBoundingClientRect(); const a = ancestor.getBoundingClientRect();
      return { left: r.left - a.left, top: r.top - a.top, width: r.width, height: r.height };
    }
    function mkFlipOverlay(side, frontHTML, backHTML){
      const host = (side==='right') ? spreadRight : spreadLeft;
      const box = rectWithin(host, flipLayer);
      const wrap = document.createElement('div');
      wrap.className = 'flip-sheet turning';
      wrap.style.left = box.left+'px'; wrap.style.top = box.top+'px';
      wrap.style.width = box.width+'px'; wrap.style.height = box.height+'px';
      wrap.style.transformOrigin = (side==='right') ? 'left center' : 'right center';
      const faceA = document.createElement('div'); faceA.className = 'flip-face front'; faceA.innerHTML = frontHTML;
      const faceB = document.createElement('div'); faceB.className = 'flip-face back';  faceB.innerHTML = backHTML;
      const shade = document.createElement('div'); shade.className = 'shade';
      wrap.appendChild(faceA); wrap.appendChild(faceB); wrap.appendChild(shade);
      flipLayer.appendChild(wrap);
      return wrap;
    }
    function nextSpread(){
      const maxSpread = Math.ceil(totalPages/2);
      if(spread >= maxSpread) return;
      const leftIndexNow  = (spread-1)*2 + 1;
      const rightIndexNow = leftIndexNow + 1;
      const leftIndexNext = leftIndexNow + 2;
      const currentRightHTML = contentRight.innerHTML;
      const nextLeftHTML     = (pages[leftIndexNext-1]?.html || '');
      const flip = mkFlipOverlay('right', currentRightHTML, nextLeftHTML);
      spread++; showSpread(spread);
      flip.classList.add('animate-forward'); flip.addEventListener('animationend', () => { flipLayer.innerHTML = ''; }, { once:true });
    }
    function prevSpread(){
      if(spread <= 1) return;
      const leftIndexNow   = (spread-1)*2 + 1;
      const rightIndexPrev = leftIndexNow - 1;
      const currentLeftHTML = contentLeft.innerHTML;
      const prevRightHTML   = (pages[rightIndexPrev-1]?.html || '');
      const flip = mkFlipOverlay('left', currentLeftHTML, prevRightHTML);
      spread--; showSpread(spread);
      flip.classList.add('animate-back'); flip.addEventListener('animationend', () => { flipLayer.innerHTML = ''; }, { once:true });
    }
    showSpread(getSavedSpread());
    document.getElementById('next-btn').addEventListener('click', nextSpread);
    document.getElementById('prev-btn').addEventListener('click', prevSpread);
    document.addEventListener('keydown', (e)=>{
      if (e.key==='ArrowRight'){ e.preventDefault(); nextSpread(); }
      if (e.key==='ArrowLeft'){  e.preventDefault(); prevSpread(); }
      if (e.key==='Escape'){ closeSheet(); closeQuiz(); }
    });

    // Dictionary events
    document.getElementById('vocab-chips')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.vocab-chip-btn'); if (!btn) return; openDefine(btn.getAttribute('data-word'));
    });
    document.getElementById('page-left').addEventListener('click', (e)=>{
      const span = e.target.closest('.word'); if(!span) return; openDefine(span.getAttribute('data-word'));
    });
    document.getElementById('page-right').addEventListener('click', (e)=>{
      const span = e.target.closest('.word'); if(!span) return; openDefine(span.getAttribute('data-word'));
    });

    /* ===== Dictionary panel ===== */
    function openSheet(){
      const sheet = document.getElementById('dict-sheet');
      sheet.classList.add('open'); sheet.setAttribute('aria-hidden', 'false');
    }
    function closeSheet(){
      const sheet = document.getElementById('dict-sheet');
      sheet.classList.remove('open'); sheet.setAttribute('aria-hidden', 'true');
    }
    document.getElementById('dict-search')?.addEventListener('click', () => {
      const w = document.getElementById('dict-input').value.trim(); if (w) openDefine(w);
    });
    document.getElementById('dict-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); document.getElementById('dict-search').click(); }
    });
    document.getElementById('dict-close')?.addEventListener('click', closeSheet);

    async function openDefine(word){
      if (!word) return; openSheet();
      const body = document.getElementById('dict-body'); const input = document.getElementById('dict-input');
      input.value = word;
      body.innerHTML = `<div class="muted"><i class="bi bi-hourglass-split"></i> Looking up <strong>${escapeHTML(word)}</strong>…</div>`;
      try{
        const res = await fetch(`/api/define?word=${encodeURIComponent(word)}`, { headers: { 'Accept': 'application/json' }});
        const j = await res.json();
        const ko = j.ko || '<span class="muted">No Korean translation found.</span>';
        const def = j.definition || '<span class="muted">No English definition found.</span>';
        body.innerHTML = `
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="dict-word mb-1">${escapeHTML(j.word || word)}</div>
              <div class="dict-sub mb-3">Korean: ${ko}</div>
            </div>
            <button class="btn btn-sm btn-fun-outline" id="bookmark-btn"
                    data-word="${escapeHTML(j.word || word)}" title="Bookmark" aria-pressed="false" data-state="off">
              <i class="bi bi-bookmark"></i>
            </button>
          </div>
          <div class="mb-2" style="font-family:Fredoka;"><span class="badge-lite">Definition</span></div>
          <div class="mb-3">${escapeHTML(def)}</div>
          <div class="small muted"><i class="bi bi-journal-check"></i> Bookmark this word if you want to keep learning about it.</div>`;
        const btn = document.getElementById('bookmark-btn');
        if (typeof j.bookmarked === 'boolean') setBookmarkVisual(btn, j.bookmarked);
        let clicking = false;
        btn?.addEventListener('click', async (e) => {
          if (clicking) return; clicking = true;
          const target = e.currentTarget;
          const w = target.getAttribute('data-word');
          const prev = getBookmarkVisual(target);
          setBookmarkVisual(target, !prev);
          try{
            const r = await fetch('/api/vocab/bookmark', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ word: w, toggle: true })
            });
            const s = await r.json().catch(() => ({}));
            if (typeof s.bookmarked === 'boolean'){ setBookmarkVisual(target, s.bookmarked); }
          }catch(_){ setBookmarkVisual(target, prev); }
          finally{ clicking = false; }
        });
      }catch(err){
        body.innerHTML = `<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> Couldn't fetch the definition.</div>`;
      }
    }
    function setBookmarkVisual(btn, isOn){
      if (!btn) return;
      if (isOn){
        btn.classList.remove('btn-fun-outline'); btn.classList.add('btn-fun');
        btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
        btn.title = 'Unbookmark'; btn.setAttribute('aria-pressed', 'true'); btn.dataset.state = 'on';
      }else{
        btn.classList.remove('btn-fun'); btn.classList.add('btn-fun-outline');
        btn.innerHTML = '<i class="bi bi-bookmark"></i>';
        btn.title = 'Bookmark'; btn.setAttribute('aria-pressed', 'false'); btn.dataset.state = 'off';
      }
    }
    function getBookmarkVisual(btn){ return (btn?.dataset.state === 'on'); }

    /* ===== Story Quiz (7 MCQ only) ===== */
    const quizModal = document.getElementById('quiz-modal');
    const openQuizBtn = document.getElementById('open-quiz');
    const closeQuizBtn = document.getElementById('quiz-close');
    const quizListEl = document.getElementById('quiz-list');
    const quizRegenBtn = document.getElementById('quiz-regenerate');
    const quizSubmitBtn = document.getElementById('quiz-submit');
    const quizMetaEl = document.getElementById('quiz-meta');
    const quizProgressEl = document.getElementById('quiz-progress');
    const quizResultEl = document.getElementById('quiz-result');
    const quizStatusPill = document.getElementById('quiz-status-pill');
    const quizAlert = document.getElementById('quiz-alert');

    let quizData = null;
    const TARGET_MCQ = 7;

    function lsKey(slug){ return `story:${slug}:quiz_status`; }
    function lsLoad(slug){
      try{ return JSON.parse(localStorage.getItem(lsKey(slug))||'null'); }catch(_){ return null; }
    }
    function lsSave(slug, obj){
      try{ localStorage.setItem(lsKey(slug), JSON.stringify(obj)); }catch(_){}
    }

    function setStatusPill(status){
      let text = 'Quiz: not started', cls='neutral';
      if (!status || status.state==='not_started'){ text='Quiz: not started'; cls='neutral'; }
      else if (status.state==='in_progress'){ text='Quiz: in progress'; cls='neutral'; }
      else if (status.state==='passed'){ text=`Quiz: Passed (${status.score}/${status.total})`; cls='ok'; }
      else if (status.state==='failed'){ text=`Quiz: Try again (${status.score}/${status.total})`; cls='bad'; }
      quizStatusPill.textContent = text;
      quizStatusPill.className = 'pill ' + (cls==='ok' ? 'ok' : cls==='bad' ? 'bad' : 'neutral');
    }

    async function fetchStatus(){
      try{
        const r = await fetch(`/api/story_quiz/${encodeURIComponent(storySlug)}/status`, { headers:{'Accept':'application/json'} });
        if (r.ok){
          const s = await r.json();
          if (s && s.state){ setStatusPill(s); return s; }
        }
      }catch(_){}
      const local = lsLoad(storySlug) || {state:'not_started'};
      setStatusPill(local);
      return local;
    }

    function openQuiz(){
      quizModal.classList.add('open'); quizModal.setAttribute('aria-hidden','false');
      quizResultEl.style.display='none';
      quizMetaEl.textContent = 'Loading…';
      quizAlert.textContent = 'Answer all questions, then Submit.';
      generateSevenMCQ();
    }
    function closeQuiz(){
      quizModal.classList.remove('open'); quizModal.setAttribute('aria-hidden','true');
    }
    openQuizBtn.addEventListener('click', openQuiz);
    closeQuizBtn.addEventListener('click', closeQuiz);
    quizModal.addEventListener('click', (e)=>{ if(e.target===quizModal) closeQuiz(); });

    // Heuristic fallback to synthesize MCQ from story text
    function synthesizeMCQFromText(sent, idx){
      const s = (sent||'').trim();
      const kw = (s.split(/\s+/)[0] || 'story').replace(/[.,!?;:]/g,'').toLowerCase();
      return {
        id: `m_synth_${idx}`,
        prompt: `Which word appears in this sentence? “${escapeHTML(s)}”`,
        options: [kw, "blue", "yesterday", "banana"],
        answer_index: 0
      };
    }

    async function generateSevenMCQ(){
      quizData = { mcq: [] };
      quizListEl.innerHTML = `<div class="muted">Preparing questions…</div>`;
      quizProgressEl.textContent = `0 / ${TARGET_MCQ}`;
      setStatusPill({state:'in_progress'});

      let base = null;
      try{
        const r = await fetch(`/api/story_quiz/${encodeURIComponent(storySlug)}/generate`, {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify({ title: storyTitle, content: rawContent })
        });
        if (r.ok){ base = await r.json(); }
      }catch(_){}

      const mcqSeed = (base && Array.isArray(base.mcq)) ? base.mcq.slice() : [];
      while (mcqSeed.length > TARGET_MCQ) mcqSeed.pop();
      if (mcqSeed.length < TARGET_MCQ){
        const sentences = (rawContent||'').split(/(?<=[.!?])\s+/).filter(s => s.trim().split(/\s+/).length >= 5);
        let si = 0;
        while (mcqSeed.length < TARGET_MCQ && si < sentences.length){
          mcqSeed.push(synthesizeMCQFromText(sentences[si++], mcqSeed.length+1));
        }
        while (mcqSeed.length < TARGET_MCQ){
          mcqSeed.push({
            id:`m_auto_${mcqSeed.length+1}`,
            prompt:"Which of these is an English word?",
            options:["story","zzqv","nmbt","xxxx"],
            answer_index:0
          });
        }
      }
      mcqSeed.forEach((m, i) => { if (!m.id) m.id = `m${i+1}`; });

      quizData.mcq = mcqSeed;
      renderQuiz();
      quizMetaEl.textContent = 'Ready';
      lsSave(storySlug, {state:'in_progress'});
    }

    quizRegenBtn.addEventListener('click', generateSevenMCQ);

    function renderQuiz(){
      const blocks = [];
      (quizData.mcq||[]).forEach((it, idx) => {
        const key = `mcq_${idx}`;
        blocks.push(`
          <div class="q-card" data-key="${key}">
            <div class="q-type">Multiple Choice</div>
            <div class="q-prompt">${escapeHTML(it.prompt||'')}</div>
            <div class="opt-row">
              ${(it.options||[]).map((o,i)=>`
                <label class="opt"><input type="radio" name="${key}" value="${i}"> ${escapeHTML(o)}</label>
              `).join('')}
            </div>
          </div>`);
      });
      quizListEl.innerHTML = blocks.join('') || '<div class="muted">No questions.</div>';
      quizProgressEl.textContent = `${countAnswered()} / ${TARGET_MCQ}`;
      quizResultEl.style.display='none';
    }

    function countAnswered(){
      let c=0;
      (quizData.mcq||[]).forEach((_,i)=>{ const v = document.querySelector(`input[name="mcq_${i}"]:checked`); if (v) c++; });
      return Math.min(c, TARGET_MCQ);
    }
    function collectAnswers(){
      const ans = {};
      (quizData.mcq||[]).forEach((_,i)=>{ const key=`mcq_${i}`; const v=document.querySelector(`input[name="${key}"]:checked`); ans[key]= (v?parseInt(v.value,10):null); });
      return ans;
    }

    /* Kid-friendly message generator */
    function kidPraise(score, total){
      const ratio = total ? score/total : 0;
      if (score === total) {
        return {
          title: "Amazing work!",
          sub: "You answered every question correctly. Keep that curiosity shining."
        };
      }
      if (ratio >= 6/7) {
        return {
          title: "Great job!",
          sub: "You understood the story really well. One more try could make it perfect."
        };
      }
      if (ratio >= 4/7) {
        return {
          title: "Nice try!",
          sub: "You’re getting the hang of it. Re-read a page and try again."
        };
      }
      return {
        title: "You’re learning!",
        sub: "Every try makes you stronger. Let’s review the story and give it another go."
      };
    }

    function gradeLocally(answers){
      let correct = 0;
      (quizData.mcq||[]).forEach((it,i)=>{
        const a = answers[`mcq_${i}`];
        if (typeof a === 'number' && a === it.answer_index) correct++;
      });
      const total = TARGET_MCQ;
      const passed = total>0 ? (correct/total)>=0.8 : false;
      return {score: correct, total, passed};
    }

    async function submitQuiz(){
      const answers = collectAnswers();
      if (countAnswered() < TARGET_MCQ){
        quizAlert.textContent = 'Please answer all questions before submitting.';
        return;
      }
      const res = gradeLocally(answers);
      showResult(res.score, res.total, res.passed, res.passed?10:0);
      setStatusPill({ state: res.passed?'passed':'failed', score:res.score, total:res.total });

      try{
        await fetch(`/api/story_quiz/${encodeURIComponent(storySlug)}/status`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ state: res.passed?'passed':'failed', score: res.score, total: res.total, xp: res.passed?10:0 })
        });
      }catch(_){}
    }

    function showResult(score, total, passed, xp){
      quizResultEl.style.display='block';
      const cls = passed ? 'ok' : 'bad';
      const praise = kidPraise(score, total);
      quizResultEl.innerHTML = `
        <div class="q-card">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <div class="q-prompt">Result</div>
              <div>Score: <strong>${score}</strong> / ${total}</div>
              <div>Status: <span class="pill ${cls}">${passed?'Passed':'Try again'}</span></div>
              ${passed ? `<div class="mt-1">XP awarded: <strong>${xp||0}</strong></div>` : ``}
            </div>
          </div>
          <div class="praise-card mt-2">
            <div style="font-family:Fredoka; font-size:1.05rem;">${praise.title}</div>
            <div class="praise-small">${praise.sub}</div>
          </div>
        </div>`;
      quizProgressEl.textContent = `${score} / ${total}`;
      quizMetaEl.textContent = passed ? 'Passed' : 'Submitted';
    }

    document.getElementById('quiz-list').addEventListener('input', ()=>{ quizProgressEl.textContent = `${countAnswered()} / ${TARGET_MCQ}`; });
    document.getElementById('quiz-list').addEventListener('change', ()=>{ quizProgressEl.textContent = `${countAnswered()} / ${TARGET_MCQ}`; });
    document.getElementById('quiz-submit').addEventListener('click', submitQuiz);

    // Initialize status on load
    fetchStatus();
  </script>
</body>
</html>
