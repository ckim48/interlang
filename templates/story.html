<!-- templates/story.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ story.title or 'Story' }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" sizes="32x32">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/apple-touch-icon.png') }}" sizes="180x180">

  <style>
    :root{
      --navy-900:#0b1220; --navy-800:#111a2e; --navy-700:#1a2642; --navy-600:#243355;
      --brand:#6ea8fe; --accent:#8f9bff; --muted:#9fb2d9; --green:#22c55e;
      --nav-h:90px; /* will be updated via JS */
    }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:#e9eefb;
      background:
        radial-gradient(1200px 800px at -10% -10%, #1a2440 0%, transparent 60%),
        radial-gradient(1000px 700px at 110% 10%, #1b2a53 0%, transparent 60%),
        linear-gradient(180deg, var(--navy-900) 0%, #0d1530 100%);
      background-attachment: fixed;
    }

    .page-card{
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(23,32,57,.6), rgba(17,26,46,.55));
      border-radius:18px; box-shadow: 0 10px 28px rgba(4,10,28,.35);
    }

    .meta-badge{ background: rgba(255,255,255,.08); color:#dfe6ff; font-weight:600; }
    .chip{ border-radius:999px; padding:.2rem .6rem; background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-weight:700; }

    /* Story content */
    .story-wrap{ line-height:1.8; font-size:1.05rem; }
    .story-wrap p{ margin-bottom:1rem; }
    .word{
      background: rgba(110,168,254,.18);
      border-bottom: 1px dashed rgba(110,168,254,.9);
      border-radius: 6px;
      padding: 0 .15rem;
      cursor: pointer;
      transition: background .15s ease;
    }
    .word:hover{ background: rgba(110,168,254,.3); }

    /* Dictionary panel (right sheet) */
    .dict-sheet{
      position: fixed;
      top: 90px;
      right: -420px;
      width: 420px; max-width: 96%;
      height: calc(100vh - var(--nav-h));
      background: #0f1836; color:#e9eefb;
      border-left: 1px solid rgba(255,255,255,.08);
      box-shadow: -20px 0 60px rgba(0,0,0,.45);
      transition: right .25s ease;
      z-index: 1040; display:flex; flex-direction:column;
    }
    .dict-sheet.open{ right:0; }
    .dict-header{
      position: sticky; top:0;
      padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(20,26,44,.85), rgba(20,26,44,.6));
      z-index: 1;
    }
    .dict-body{ padding:16px; overflow:auto; }
    .dict-word{ font-size:1.35rem; font-weight:800; }
    .dict-sub{ color:#b9c6e5; }

    .loading{ opacity:.65; pointer-events:none; }
    .muted{ color:#9fb2d9; }
  </style>
</head>
<body>
  {% include 'nav.html' %}

  <div class="container pb-5 mt-4">
    <!-- Header -->
    <div class="page-card p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <div class="pe-2">
          <h1 class="h4 mb-1">{{ story.title or 'Story' }}</h1>
          <div class="muted small">by {{ story.author or 'Unknown' }}</div>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <span class="badge meta-badge">Age {{ story.age_min or 8 }}–{{ story.age_max or 12 }}</span>
          <span class="badge meta-badge">Difficulty {{ story.difficulty or 2 }}</span>
        </div>
      </div>
    </div>

    <!-- Vocabulary chips -->
    <div class="page-card p-3 mb-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="fw-bold"><i class="bi bi-lightbulb"></i> Vocabulary from this story</div>
        <div class="small muted">Click a word to see its meaning.</div>
      </div>
      <div class="d-flex flex-wrap gap-2" id="vocab-chips">
        {% for w in vocab %}
          <button type="button" class="btn btn-sm btn-outline-info vocab-chip" data-word="{{ w|e }}">{{ w }}</button>
        {% endfor %}
        {% if not vocab %}
          <div class="muted">No vocabulary extracted.</div>
        {% endif %}
      </div>
    </div>

    <!-- Story content -->
    <div class="page-card p-3">
      <div class="story-wrap" id="story-wrap">
        {% for para in (content or '').
                        replace('\r\n','\n').
                        replace('\r','\n').
                        split('\n\n') %}
          <p class="story-paragraph">{{ para|e }}</p>
        {% endfor %}
      </div>
      <div class="small muted mt-2"><i class="bi bi-info-circle"></i> Vocabulary is highlighted automatically. Click a highlighted word to open the dictionary.</div>
    </div>
  </div>

  <!-- Dictionary sheet -->
  <div class="dict-sheet" id="dict-sheet" aria-hidden="true">
    <div class="dict-header">
      <div class="fw-bold"><i class="bi bi-translate"></i> Dictionary</div>
      <div class="d-flex align-items-center gap-2">
        <input id="dict-input" class="form-control form-control-sm d-inline-block" style="width: 160px;" placeholder="Look up a word…" />
        <button id="dict-search" class="btn btn-sm btn-primary"><i class="bi bi-search"></i></button>
        <button id="dict-close" class="btn btn-sm btn-outline-light"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="dict-body" id="dict-body">
      <div class="muted">Choose a word to see details.</div>
    </div>
  </div>

  <script>
    // Respect fixed navbar height for the sheet
    function setNavHeightVar(){
      const nav = document.querySelector('.navbar.fixed-top, nav.navbar.fixed-top');
      const h = nav ? Math.round(nav.getBoundingClientRect().height) : 56;
      document.documentElement.style.setProperty('--nav-h', h + 'px');
    }
    window.addEventListener('load', setNavHeightVar);
    window.addEventListener('resize', setNavHeightVar);

    // Data from server
    window.storyVocab = {{ (vocab or []) | tojson }};

    // Highlight function: wrap whole-word matches (case-insensitive)
    function highlightParagraph(el, words){
      const text = el.textContent;
      if (!text || !words || !words.length) return;
      const escaped = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\\\$&'));
      const re = new RegExp("\\b(" + escaped.join("|") + ")\\b", "gi");
      const html = text.replace(re, (m) => `<span class="word" data-word="${m.toLowerCase()}">${m}</span>`);
      el.innerHTML = html;
    }

    function setBookmarkVisual(btn, isOn){
      if (!btn) return;
      if (isOn){
        btn.classList.remove('btn-outline-warning');
        btn.classList.add('btn-warning');
        btn.innerHTML = '<i class="bi bi-bookmark-fill"></i>';
        btn.title = 'Unbookmark';
        btn.setAttribute('aria-pressed', 'true');
        btn.dataset.state = 'on';
      }else{
        btn.classList.remove('btn-warning');
        btn.classList.add('btn-outline-warning');
        btn.innerHTML = '<i class="bi bi-bookmark"></i>';
        btn.title = 'Bookmark';
        btn.setAttribute('aria-pressed', 'false');
        btn.dataset.state = 'off';
      }
    }
    function getBookmarkVisual(btn){
      return (btn?.dataset.state === 'on');
    }

    document.addEventListener('DOMContentLoaded', () => {
      const paras = document.querySelectorAll('.story-paragraph');
      const uniq = Array.from(new Set((window.storyVocab || []).map(w => (w||"").toLowerCase()))).filter(Boolean);
      paras.forEach(p => highlightParagraph(p, uniq));

      // Chip clicks
      document.getElementById('vocab-chips')?.addEventListener('click', (e) => {
        const btn = e.target.closest('.vocab-chip'); if (!btn) return;
        const w = btn.getAttribute('data-word');
        openDefine(w);
      });

      // Word clicks in content
      document.getElementById('story-wrap')?.addEventListener('click', (e) => {
        const span = e.target.closest('.word'); if (!span) return;
        const w = span.getAttribute('data-word');
        openDefine(w);
      });

      // Dictionary search
      document.getElementById('dict-search')?.addEventListener('click', () => {
        const w = document.getElementById('dict-input').value.trim();
        if (w) openDefine(w);
      });
      document.getElementById('dict-input')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('dict-search').click();
        }
      });

      // Close sheet (buttons + Esc)
      document.getElementById('dict-close')?.addEventListener('click', closeSheet);
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeSheet(); });
    });

    function openSheet(){
      const sheet = document.getElementById('dict-sheet');
      sheet.classList.add('open');
      sheet.setAttribute('aria-hidden', 'false');
    }
    function closeSheet(){
      const sheet = document.getElementById('dict-sheet');
      sheet.classList.remove('open');
      sheet.setAttribute('aria-hidden', 'true');
    }

    async function openDefine(word){
      if (!word) return;
      openSheet();
      const body = document.getElementById('dict-body');
      const input = document.getElementById('dict-input');
      input.value = word;

      body.innerHTML = `
        <div class="muted"><i class="bi bi-hourglass-split"></i> Looking up <strong>${escapeHTML(word)}</strong>…</div>
      `;
      try{
        const res = await fetch(`/api/define?word=${encodeURIComponent(word)}`, { headers: { 'Accept': 'application/json' }});
        const j = await res.json();
        const ko = j.ko || '<span class="muted">No Korean translation found.</span>';
        const def = j.definition || '<span class="muted">No English definition found.</span>';

        body.innerHTML = `
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="dict-word mb-1">${escapeHTML(j.word || word)}</div>
              <div class="dict-sub mb-3">Korean: ${ko}</div>
            </div>
            <button class="btn btn-outline-warning btn-sm" id="bookmark-btn"
                    data-word="${escapeHTML(j.word || word)}" title="Bookmark" aria-pressed="false" data-state="off">
              <i class="bi bi-bookmark"></i>
            </button>
          </div>
          <div class="mb-2"><span class="chip"><i class="bi bi-book"></i> Definition</span></div>
          <div class="mb-3">${escapeHTML(def)}</div>
          <div class="small muted"><i class="bi bi-journal-check"></i> This word is saved to your vocabulary notebook while you read.</div>
        `;

        const btn = document.getElementById('bookmark-btn');
        // Initialize from server if provided
        if (typeof j.bookmarked === 'boolean') setBookmarkVisual(btn, j.bookmarked);

        let clicking = false;
        btn?.addEventListener('click', async (e) => {
          if (clicking) return;
          clicking = true;

          const target = e.currentTarget;
          const w = target.getAttribute('data-word');

          // Optimistic toggle
          const prev = getBookmarkVisual(target);
          setBookmarkVisual(target, !prev);

          try{
            const r = await fetch('/api/vocab/bookmark', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ word: w, toggle: true })
            });
            const s = await r.json().catch(() => ({}));

            // If server returns truth, trust it; else keep optimistic state
            if (typeof s.bookmarked === 'boolean'){
              setBookmarkVisual(target, s.bookmarked);
            }
          }catch(_){
            // Revert on hard failure
            setBookmarkVisual(target, prev);
          }finally{
            clicking = false;
          }
        });

      }catch(err){
        body.innerHTML = `<div class="text-danger"><i class="bi bi-exclamation-triangle"></i> Couldn't fetch the definition.</div>`;
      }
    }

    function escapeHTML(s){
      return (s||'').replace(/[&<>"'`=\/]/g, function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
